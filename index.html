<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>28年后 你还会想起我吗</title> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="resources/css/index.css">
    <link rel="icon" href="resources/images/logo.png" type="image/png">

    <style>
        /* ----------------------- 弹幕功能 CSS (已优化定位) ----------------------- */
        
        /* 弹幕容器：占满背景区域 */
        #danmaku-container {
            position: absolute; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* 占满屏幕 */
            background-color: transparent;
            overflow: hidden; 
            pointer-events: none; /* 不阻挡背景视频或点击事件 */
            z-index: 10; 
        }

        /* 单个弹幕样式 */
        .danmaku-item {
            position: absolute;
            white-space: nowrap; 
            font-size: 24px;
            font-weight: bold;
            color: #fff; 
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); 
            right: 0; 
            pointer-events: none; 
            animation: scroll-danmaku 10s linear forwards; 
        }

        /* 关键帧动画 */
        @keyframes scroll-danmaku {
            from { transform: translateX(0); }
            to { transform: translateX(calc(-100% - 100vw)); } 
        }

        /* 输入区域样式 */
        #danmaku-input-area {
            position: fixed; /* 固定在屏幕底部 */
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            z-index: 20; 
            pointer-events: all; /* 允许点击和输入 */
            display: flex; 
            gap: 10px;
        }
        #comment-input {
            padding: 10px;
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.9); /* 稍微透明的背景，便于阅读 */
        }
        #send-btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="intro">
        <div class="intro-inner" role="dialog" aria-label="Intro">
            <div class="intro-line">
                <span>Hello World</span>
                <span class="dots" aria-hidden="true"></span>
                <span class="caret" aria-hidden="true"></span>
            </div>
            <div class="intro-hint" aria-hidden="true">Please Press Any Key♪</div>
        </div>
    </div>
    
    <div class="background">
        <div id="danmaku-container"></div>
        
        <video
            id="bg-video"
            class="background-video"
            autoplay
            muted
            loop
            playsinline
            webkit-playsinline
            x5-playsplaysinline="true"
            x5-video-player-type="h5"
            preload="auto"
            disablepictureinpicture
            controlsList="nodownload nofullscreen noremoteplayback"
            data-desktop-src="resources/images/cyrene.mp4"
            data-mobile-src="resources/images/lulu.mp4"
            src="resources/images/cyrene.mp4">
        </video>
        
        <div class="lang-switch">
            <span id="switch-en" role="button" tabindex="0">EN</span> |
            <span id="switch-zh" role="button" tabindex="0">ZH</span>
        </div>
        
        <div class="gradient-overlay"></div>
        
        <div class="content">
            <h2 class="title">H E L L O &nbsp; W O R L D</h2>
            <div class="time-box">
                <div class="days"><p class="day value">00</p><span class="text">days</span></div>
                <div class="hours"><p class="hour value">00</p><span class="text">hours</span></div>
                <div class="mins"><p class="min value">00</p><span class="text">min</span></div>
                <div class="secs"><p class="sec value">00</p><span class="text">sec</span></div>
            </div>
            <p class="sub-title">「This time, together with me…」</p>
            <p class="sub-title">「Let’s write a new chapter of the story♪」</p>
            <p class="sub-title tips"></p>
        </div>
        
        <div class="meta-row">
            <div class="icp-box">
                <a class="meta-badge icp" href="https://icp.gov.moe/?keyword=20257728" target="_blank">萌ICP备20257728号</a>
            </div>
            <a class="meta-badge email" href="mailto:762930756@qq.com">
                <svg width="16" height="16" viewBox="0 0 24 24"><path d="M2 5h20v14H2V5zm2 2v10h16V7l-8 5L4 7z" fill="currentColor"/></svg>
                <span>762930756@qq.com</span>
            </a>
        </div>
        
        <div class="music-control">
            <img id="music-btn" src="resources/images/musicon.webp" alt="Music Toggle">
        </div>
    </div>
    
    <div id="danmaku-input-area">
        <input type="text" id="comment-input" placeholder="发送一条实时弹幕...">
        <button id="send-btn">发送弹幕</button>
    </div>

    <audio id="bg-music" preload="none" loop>
        <source src="resources/audio/true.mp3" type="audio/mpeg">
    </audio>

    <footer class="footer">
        © This website is solely dedicated to documenting the 28-year promise between Shizuku Lulu and the Lulumins.
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@latest/dist/av-core-mini.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-realtime@latest/dist/av-realtime.js"></script>

    <script src="resources/js/jquery-3.2.1.min.js"></script>    
    
    <script src="resources/js/index.js"></script>

    <script>
        // 【已替换】你的密钥
        const APP_ID = 'm7d44WKW3c28c4AD5YedvDjF-MdYXbMMI'; 
        const APP_KEY = 'tmEhn2GeWMwa0SmKYT4JTzbo'; 
        const CONVERSATION_ID = 'global-danmaku-room';
        const clientID = 'anon-' + Math.random().toString(36).substring(7);

        // 获取 DOM 元素
        const danmakuContainer = document.getElementById('danmaku-container');
        const input = document.getElementById('comment-input');
        const sendBtn = document.getElementById('send-btn');

        let realtime = null;
        let conversation = null;

        // --- A. 弹幕渲染和动效函数 ---
        function renderDanmaku(text) {
            if (!danmakuContainer || !text) return; 
            const danmaku = document.createElement('div');
            danmaku.className = 'danmaku-item';
            danmaku.textContent = text;
            
            const containerHeight = danmakuContainer.clientHeight;
            const danmakuHeight = 30; 
            const topPosition = Math.floor(Math.random() * (containerHeight * 0.8));
            danmaku.style.top = `${topPosition}px`;
            
            danmakuContainer.appendChild(danmaku);
            danmaku.addEventListener('animationend', () => { danmaku.remove(); });
        }

        // --- B. 连接和监听实时消息 (已修复逻辑) ---
        async function setupDanmaku() {
            try {
                // 1. 初始化 AV (现在 AV 应该已定义)
                AV.init({
                    appId: APP_ID,
                    appKey: APP_KEY
                });
                
                // 2. 简化的 Realtime 初始化
                realtime = new AV.Realtime({ appId: APP_ID }); 

                const client = await realtime.createIMClient(clientID);
                
                conversation = await client.getConversation(CONVERSATION_ID, {
                    name: 'Danmaku Room',
                    isUnique: true,
                    transient: false 
                });

                client.on('message', (message, convo) => {
                    if (convo.id === CONVERSATION_ID) {
                        renderDanmaku(message.getText());
                    }
                });
                
                console.log('LeanCloud 实时连接成功！');

            } catch (error) {
                console.error('LeanCloud 连接失败:', error); 
                // 错误提示 (在控制台显示，避免弹窗干扰用户)
                if (error.code === 4100) { console.log('LeanCloud 应用处于休眠期。'); }
                else if (error.code === 4101) { console.log('App ID 或 App Key 配置错误。'); }
                else { console.log('未知连接错误。'); }
            }
        }

        // --- C. 发送弹幕函数 ---
        sendBtn.addEventListener('click', async () => {
            const text = input.value.trim();
            if (!text) return;

            if (!conversation) {
                 alert('弹幕服务未连接或正在连接中，请稍候再试。');
                 return;
            }

            if (text.length > 50) {
                alert('弹幕内容过长（限制50字）');
                return;
            }

            const message = new AV.TextMessage(text);

            try {
                await conversation.send(message);
                input.value = '';
            } catch (e) {
                console.error("发送失败:", e);
                alert('发送弹幕失败，请检查网络或 LeanCloud 状态。');
            }
        });

        // 页面加载完成后启动
        window.onload = setupDanmaku;
    </script>
</body>
</html>
