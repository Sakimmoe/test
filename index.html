<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luluwo 的网站 - 实时弹幕评论</title>
    
    <style>
        /* ⚠️ 你的原有 CSS 样式可以放在这里，或者放在外部 CSS 文件中 ⚠️ */
        /* ---------------------------------------------------- */
        
        /* 页面基础样式 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            text-align: center;
        }

        /* 弹幕容器：关键设置 */
        #danmaku-container {
            position: relative; 
            width: 80%;
            max-width: 1000px;
            height: 400px; /* 调整高度以适应你的网站 */
            margin: 20px auto;
            background-color: #333; /* 黑色背景，使白色弹幕更突出 */
            border: 1px solid #ccc;
            overflow: hidden; 
            /* 确保弹幕不会影响用户点击下方的元素 */
            pointer-events: none; 
        }

        /* 单个弹幕样式 */
        .danmaku-item {
            position: absolute;
            white-space: nowrap; 
            font-size: 24px;
            font-weight: bold;
            color: #fff; 
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); 
            right: 0; /* 初始位置：从最右侧开始 */
            
            /* 核心：应用动画。10s 匀速滚动时间 */
            animation: scroll-danmaku 10s linear forwards; 
        }

        /* 关键帧动画：定义弹幕从右到左的移动 */
        @keyframes scroll-danmaku {
            from { transform: translateX(0); }
            /* 移动距离：确保弹幕完全移出屏幕左侧 */
            to { transform: translateX(calc(-100% - 100vw)); } 
        }

        /* 输入区域样式 */
        #danmaku-input-area {
            margin: 20px auto;
            width: 80%;
            max-width: 1000px;
        }
        #comment-input {
            padding: 10px;
            width: 70%;
            border: 1px solid #ccc;
        }
        #send-btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>欢迎回到 Luluwo 的网站！</h1>
    <p>这是你网站的原有内容，现在可以在下方观看和发送实时弹幕。</p>
    
    <div id="danmaku-container">
        </div>

    <div id="danmaku-input-area">
        <input type="text" id="comment-input" placeholder="输入弹幕内容...">
        <button id="send-btn">发送弹幕</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@latest/dist/av-core-mini.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-realtime@latest/dist/av-realtime.js"></script>

    <script>
        // 【已替换】你的密钥和服务器地址
        const APP_ID = 'm7d44WKW3c28c4AD5YedvDjF-MdYXbMMI'; 
        const APP_KEY = 'tmEhn2GeWMwa0SmKYT4JTzbo'; 
        const REST_API_URL = 'https://m7d44wkw.api.lncldglobal.com'; 

        const CONVERSATION_ID = 'global-danmaku-room'; // 弹幕频道ID
        const clientID = 'anon-' + Math.random().toString(36).substring(7);

        // 初始化 LeanCloud
        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURLs: REST_API_URL 
        });

        // 获取 DOM 元素
        const danmakuContainer = document.getElementById('danmaku-container');
        const input = document.getElementById('comment-input');
        const sendBtn = document.getElementById('send-btn');

        let realtime = null;
        let conversation = null;

        // --- A. 弹幕渲染和动效函数 ---
        function renderDanmaku(text) {
            if (!danmakuContainer || !text) return; 

            const danmaku = document.createElement('div');
            danmaku.className = 'danmaku-item';
            danmaku.textContent = text;
            
            const containerHeight = danmakuContainer.clientHeight;
            const danmakuHeight = 30; 
            
            const topPosition = Math.floor(Math.random() * (containerHeight - danmakuHeight)); 
            danmaku.style.top = `${topPosition}px`;
            
            danmakuContainer.appendChild(danmaku);

            danmaku.addEventListener('animationend', () => {
                danmaku.remove();
            });
        }

        // --- B. 连接和监听实时消息 (已修复逻辑) ---
        async function setupDanmaku() {
            try {
                // 1. 简化的 Realtime 初始化，让 SDK 自己处理 RTM 域名解析
                realtime = new AV.Realtime({ appId: APP_ID }); 

                // 2. 匿名登录客户端
                const client = await realtime.createIMClient(clientID);
                
                // 3. 获取或创建一个公共聊天室
                conversation = await client.getConversation(CONVERSATION_ID, {
                    name: 'Danmaku Room',
                    isUnique: true,
                    transient: false 
                });

                // 4. 设置消息监听器
                client.on('message', (message, convo) => {
                    if (convo.id === CONVERSATION_ID) {
                        renderDanmaku(message.getText());
                    }
                });
                
                console.log('LeanCloud 实时连接成功！');

            } catch (error) {
                console.error('LeanCloud 连接失败:', error); 

                let errorMessage = '弹幕服务连接失败。';
                if (error.code === 4100) {
                    errorMessage += '（错误代码 4100：应用可能处于免费版的休眠期。）';
                }
                
                alert(errorMessage);
            }
        }

        // --- C. 发送弹幕函数 ---
        sendBtn.addEventListener('click', async () => {
            const text = input.value.trim();
            if (!text) return;

            // 修复点：在发送前检查 conversation 是否已成功建立
            if (!conversation) {
                 alert('弹幕服务未连接或正在连接中，请稍候再试。');
                 return;
            }

            if (text.length > 50) {
                alert('弹幕内容过长（限制50字）');
                return;
            }

            const message = new AV.TextMessage(text);

            try {
                await conversation.send(message);
                input.value = ''; // 清空输入框
            } catch (e) {
                console.error("发送失败:", e);
                alert('发送弹幕失败，请检查网络或 LeanCloud 状态。');
            }
        });

        // 页面加载完成后启动
        window.onload = setupDanmaku;
    </script>
</body>
</html>
