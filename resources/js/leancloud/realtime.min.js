/**
 * Minified by jsDelivr using Terser v5.39.0.
 * Original file: /npm/leancloud-realtime@4.3.0/dist/realtime.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=_interopDefault(require("babel-runtime/helpers/extends")),_Promise=_interopDefault(require("babel-runtime/core-js/promise")),protobufLight=_interopDefault(require("protobufjs/dist/protobuf-light")),EventEmitter=_interopDefault(require("eventemitter3")),_regeneratorRuntime=_interopDefault(require("babel-runtime/regenerator")),_asyncToGenerator=_interopDefault(require("babel-runtime/helpers/asyncToGenerator")),_toConsumableArray=_interopDefault(require("babel-runtime/helpers/toConsumableArray")),_Set=_interopDefault(require("babel-runtime/core-js/set")),_Object$assign=_interopDefault(require("babel-runtime/core-js/object/assign")),_objectWithoutProperties=_interopDefault(require("babel-runtime/helpers/objectWithoutProperties")),_classCallCheck=_interopDefault(require("babel-runtime/helpers/classCallCheck")),_possibleConstructorReturn=_interopDefault(require("babel-runtime/helpers/possibleConstructorReturn")),_inherits=_interopDefault(require("babel-runtime/helpers/inherits")),d=_interopDefault(require("debug")),axios=_interopDefault(require("axios")),shuffle=_interopDefault(require("lodash/shuffle")),_Symbol=_interopDefault(require("babel-runtime/core-js/symbol")),_Object$getOwnPropertyDescriptor=_interopDefault(require("babel-runtime/core-js/object/get-own-property-descriptor")),_toArray=_interopDefault(require("babel-runtime/helpers/toArray")),_createClass=_interopDefault(require("babel-runtime/helpers/createClass")),StateMachine=_interopDefault(require("javascript-state-machine")),WebSocket=_interopDefault(require("ws")),_typeof=_interopDefault(require("babel-runtime/helpers/typeof")),_JSON$stringify=_interopDefault(require("babel-runtime/core-js/json/stringify")),_WeakMap=_interopDefault(require("babel-runtime/core-js/weak-map")),_Array$from=_interopDefault(require("babel-runtime/core-js/array/from")),_defineProperty=_interopDefault(require("babel-runtime/helpers/defineProperty")),_Object$keys=_interopDefault(require("babel-runtime/core-js/object/keys")),isPlainObject=_interopDefault(require("lodash/isPlainObject")),_Object$freeze=_interopDefault(require("babel-runtime/core-js/object/freeze")),_Object$defineProperty=_interopDefault(require("babel-runtime/core-js/object/define-property")),uuid=_interopDefault(require("uuid/v4")),_slicedToArray=_interopDefault(require("babel-runtime/helpers/slicedToArray")),_Object$values=_interopDefault(require("babel-runtime/core-js/object/values")),base64Arraybuffer=require("base64-arraybuffer"),remove=_interopDefault(require("lodash/remove")),_Array$find=_interopDefault(require("babel-runtime/core-js/array/find")),isEmpty=_interopDefault(require("lodash/isEmpty")),cloneDeep=_interopDefault(require("lodash/cloneDeep")),_getIterator=_interopDefault(require("babel-runtime/core-js/get-iterator")),messageCompiled=protobufLight.newBuilder({}).import({package:"push_server.messages2",syntax:"proto2",options:{objc_class_prefix:"AVIM"},messages:[{name:"JsonObjectMessage",syntax:"proto2",fields:[{rule:"required",type:"string",name:"data",id:1}]},{name:"UnreadTuple",syntax:"proto2",fields:[{rule:"required",type:"string",name:"cid",id:1},{rule:"required",type:"int32",name:"unread",id:2},{rule:"optional",type:"string",name:"mid",id:3},{rule:"optional",type:"int64",name:"timestamp",id:4},{rule:"optional",type:"string",name:"from",id:5},{rule:"optional",type:"string",name:"data",id:6},{rule:"optional",type:"int64",name:"patchTimestamp",id:7},{rule:"optional",type:"bool",name:"mentioned",id:8},{rule:"optional",type:"bytes",name:"binaryMsg",id:9},{rule:"optional",type:"int32",name:"convType",id:10}]},{name:"LogItem",syntax:"proto2",fields:[{rule:"optional",type:"string",name:"from",id:1},{rule:"optional",type:"string",name:"data",id:2},{rule:"optional",type:"int64",name:"timestamp",id:3},{rule:"optional",type:"string",name:"msgId",id:4},{rule:"optional",type:"int64",name:"ackAt",id:5},{rule:"optional",type:"int64",name:"readAt",id:6},{rule:"optional",type:"int64",name:"patchTimestamp",id:7},{rule:"optional",type:"bool",name:"mentionAll",id:8},{rule:"repeated",type:"string",name:"mentionPids",id:9},{rule:"optional",type:"bool",name:"bin",id:10},{rule:"optional",type:"int32",name:"convType",id:11}]},{name:"ConvMemberInfo",syntax:"proto2",fields:[{rule:"optional",type:"string",name:"pid",id:1},{rule:"optional",type:"string",name:"role",id:2},{rule:"optional",type:"string",name:"infoId",id:3}]},{name:"DataCommand",syntax:"proto2",fields:[{rule:"repeated",type:"string",name:"ids",id:1},{rule:"repeated",type:"JsonObjectMessage",name:"msg",id:2},{rule:"optional",type:"bool",name:"offline",id:3}]},{name:"SessionCommand",syntax:"proto2",fields:[{rule:"optional",type:"int64",name:"t",id:1},{rule:"optional",type:"string",name:"n",id:2},{rule:"optional",type:"string",name:"s",id:3},{rule:"optional",type:"string",name:"ua",id:4},{rule:"optional",type:"bool",name:"r",id:5},{rule:"optional",type:"string",name:"tag",id:6},{rule:"optional",type:"string",name:"deviceId",id:7},{rule:"repeated",type:"string",name:"sessionPeerIds",id:8},{rule:"repeated",type:"string",name:"onlineSessionPeerIds",id:9},{rule:"optional",type:"string",name:"st",id:10},{rule:"optional",type:"int32",name:"stTtl",id:11},{rule:"optional",type:"int32",name:"code",id:12},{rule:"optional",type:"string",name:"reason",id:13},{rule:"optional",type:"string",name:"deviceToken",id:14},{rule:"optional",type:"bool",name:"sp",id:15},{rule:"optional",type:"string",name:"detail",id:16},{rule:"optional",type:"int64",name:"lastUnreadNotifTime",id:17},{rule:"optional",type:"int64",name:"lastPatchTime",id:18},{rule:"optional",type:"int64",name:"configBitmap",id:19}]},{name:"ErrorCommand",syntax:"proto2",fields:[{rule:"required",type:"int32",name:"code",id:1},{rule:"required",type:"string",name:"reason",id:2},{rule:"optional",type:"int32",name:"appCode",id:3},{rule:"optional",type:"string",name:"detail",id:4},{rule:"repeated",type:"string",name:"pids",id:5},{rule:"optional",type:"string",name:"appMsg",id:6}]},{name:"DirectCommand",syntax:"proto2",fields:[{rule:"optional",type:"string",name:"msg",id:1},{rule:"optional",type:"string",name:"uid",id:2},{rule:"optional",type:"string",name:"fromPeerId",id:3},{rule:"optional",type:"int64",name:"timestamp",id:4},{rule:"optional",type:"bool",name:"offline",id:5},{rule:"optional",type:"bool",name:"hasMore",id:6},{rule:"repeated",type:"string",name:"toPeerIds",id:7},{rule:"optional",type:"bool",name:"r",id:10},{rule:"optional",type:"string",name:"cid",id:11},{rule:"optional",type:"string",name:"id",id:12},{rule:"optional",type:"bool",name:"transient",id:13},{rule:"optional",type:"string",name:"dt",id:14},{rule:"optional",type:"string",name:"roomId",id:15},{rule:"optional",type:"string",name:"pushData",id:16},{rule:"optional",type:"bool",name:"will",id:17},{rule:"optional",type:"int64",name:"patchTimestamp",id:18},{rule:"optional",type:"bytes",name:"binaryMsg",id:19},{rule:"repeated",type:"string",name:"mentionPids",id:20},{rule:"optional",type:"bool",name:"mentionAll",id:21},{rule:"optional",type:"int32",name:"convType",id:22}]},{name:"AckCommand",syntax:"proto2",fields:[{rule:"optional",type:"int32",name:"code",id:1},{rule:"optional",type:"string",name:"reason",id:2},{rule:"optional",type:"string",name:"mid",id:3},{rule:"optional",type:"string",name:"cid",id:4},{rule:"optional",type:"int64",name:"t",id:5},{rule:"optional",type:"string",name:"uid",id:6},{rule:"optional",type:"int64",name:"fromts",id:7},{rule:"optional",type:"int64",name:"tots",id:8},{rule:"optional",type:"string",name:"type",id:9},{rule:"repeated",type:"string",name:"ids",id:10},{rule:"optional",type:"int32",name:"appCode",id:11},{rule:"optional",type:"string",name:"appMsg",id:12}]},{name:"UnreadCommand",syntax:"proto2",fields:[{rule:"repeated",type:"UnreadTuple",name:"convs",id:1},{rule:"optional",type:"int64",name:"notifTime",id:2}]},{name:"ConvCommand",syntax:"proto2",fields:[{rule:"repeated",type:"string",name:"m",id:1},{rule:"optional",type:"bool",name:"transient",id:2},{rule:"optional",type:"bool",name:"unique",id:3},{rule:"optional",type:"string",name:"cid",id:4},{rule:"optional",type:"string",name:"cdate",id:5},{rule:"optional",type:"string",name:"initBy",id:6},{rule:"optional",type:"string",name:"sort",id:7},{rule:"optional",type:"int32",name:"limit",id:8},{rule:"optional",type:"int32",name:"skip",id:9},{rule:"optional",type:"int32",name:"flag",id:10},{rule:"optional",type:"int32",name:"count",id:11},{rule:"optional",type:"string",name:"udate",id:12},{rule:"optional",type:"int64",name:"t",id:13},{rule:"optional",type:"string",name:"n",id:14},{rule:"optional",type:"string",name:"s",id:15},{rule:"optional",type:"bool",name:"statusSub",id:16},{rule:"optional",type:"bool",name:"statusPub",id:17},{rule:"optional",type:"int32",name:"statusTTL",id:18},{rule:"optional",type:"string",name:"uniqueId",id:19},{rule:"optional",type:"string",name:"targetClientId",id:20},{rule:"optional",type:"int64",name:"maxReadTimestamp",id:21},{rule:"optional",type:"int64",name:"maxAckTimestamp",id:22},{rule:"optional",type:"bool",name:"queryAllMembers",id:23},{rule:"repeated",type:"MaxReadTuple",name:"maxReadTuples",id:24},{rule:"repeated",type:"string",name:"cids",id:25},{rule:"optional",type:"ConvMemberInfo",name:"info",id:26},{rule:"optional",type:"bool",name:"tempConv",id:27},{rule:"optional",type:"int32",name:"tempConvTTL",id:28},{rule:"repeated",type:"string",name:"tempConvIds",id:29},{rule:"repeated",type:"string",name:"allowedPids",id:30},{rule:"repeated",type:"ErrorCommand",name:"failedPids",id:31},{rule:"optional",type:"string",name:"next",id:40},{rule:"optional",type:"JsonObjectMessage",name:"results",id:100},{rule:"optional",type:"JsonObjectMessage",name:"where",id:101},{rule:"optional",type:"JsonObjectMessage",name:"attr",id:103},{rule:"optional",type:"JsonObjectMessage",name:"attrModified",id:104}]},{name:"RoomCommand",syntax:"proto2",fields:[{rule:"optional",type:"string",name:"roomId",id:1},{rule:"optional",type:"string",name:"s",id:2},{rule:"optional",type:"int64",name:"t",id:3},{rule:"optional",type:"string",name:"n",id:4},{rule:"optional",type:"bool",name:"transient",id:5},{rule:"repeated",type:"string",name:"roomPeerIds",id:6},{rule:"optional",type:"string",name:"byPeerId",id:7}]},{name:"LogsCommand",syntax:"proto2",fields:[{rule:"optional",type:"string",name:"cid",id:1},{rule:"optional",type:"int32",name:"l",id:2},{rule:"optional",type:"int32",name:"limit",id:3},{rule:"optional",type:"int64",name:"t",id:4},{rule:"optional",type:"int64",name:"tt",id:5},{rule:"optional",type:"string",name:"tmid",id:6},{rule:"optional",type:"string",name:"mid",id:7},{rule:"optional",type:"string",name:"checksum",id:8},{rule:"optional",type:"bool",name:"stored",id:9},{rule:"optional",type:"QueryDirection",name:"direction",id:10,options:{default:"OLD"}},{rule:"optional",type:"bool",name:"tIncluded",id:11},{rule:"optional",type:"bool",name:"ttIncluded",id:12},{rule:"optional",type:"int32",name:"lctype",id:13},{rule:"repeated",type:"LogItem",name:"logs",id:105}],enums:[{name:"QueryDirection",syntax:"proto2",values:[{name:"OLD",id:1},{name:"NEW",id:2}]}]},{name:"RcpCommand",syntax:"proto2",fields:[{rule:"optional",type:"string",name:"id",id:1},{rule:"optional",type:"string",name:"cid",id:2},{rule:"optional",type:"int64",name:"t",id:3},{rule:"optional",type:"bool",name:"read",id:4},{rule:"optional",type:"string",name:"from",id:5}]},{name:"ReadTuple",syntax:"proto2",fields:[{rule:"required",type:"string",name:"cid",id:1},{rule:"optional",type:"int64",name:"timestamp",id:2},{rule:"optional",type:"string",name:"mid",id:3}]},{name:"MaxReadTuple",syntax:"proto2",fields:[{rule:"optional",type:"string",name:"pid",id:1},{rule:"optional",type:"int64",name:"maxAckTimestamp",id:2},{rule:"optional",type:"int64",name:"maxReadTimestamp",id:3}]},{name:"ReadCommand",syntax:"proto2",fields:[{rule:"optional",type:"string",name:"cid",id:1},{rule:"repeated",type:"string",name:"cids",id:2},{rule:"repeated",type:"ReadTuple",name:"convs",id:3}]},{name:"PresenceCommand",syntax:"proto2",fields:[{rule:"optional",type:"StatusType",name:"status",id:1},{rule:"repeated",type:"string",name:"sessionPeerIds",id:2},{rule:"optional",type:"string",name:"cid",id:3}]},{name:"ReportCommand",syntax:"proto2",fields:[{rule:"optional",type:"bool",name:"initiative",id:1},{rule:"optional",type:"string",name:"type",id:2},{rule:"optional",type:"string",name:"data",id:3}]},{name:"PatchItem",syntax:"proto2",fields:[{rule:"optional",type:"string",name:"cid",id:1},{rule:"optional",type:"string",name:"mid",id:2},{rule:"optional",type:"int64",name:"timestamp",id:3},{rule:"optional",type:"bool",name:"recall",id:4},{rule:"optional",type:"string",name:"data",id:5},{rule:"optional",type:"int64",name:"patchTimestamp",id:6},{rule:"optional",type:"string",name:"from",id:7},{rule:"optional",type:"bytes",name:"binaryMsg",id:8},{rule:"optional",type:"bool",name:"mentionAll",id:9},{rule:"repeated",type:"string",name:"mentionPids",id:10},{rule:"optional",type:"int64",name:"patchCode",id:11},{rule:"optional",type:"string",name:"patchReason",id:12}]},{name:"PatchCommand",syntax:"proto2",fields:[{rule:"repeated",type:"PatchItem",name:"patches",id:1},{rule:"optional",type:"int64",name:"lastPatchTime",id:2}]},{name:"PubsubCommand",syntax:"proto2",fields:[{rule:"optional",type:"string",name:"cid",id:1},{rule:"repeated",type:"string",name:"cids",id:2},{rule:"optional",type:"string",name:"topic",id:3},{rule:"optional",type:"string",name:"subtopic",id:4},{rule:"repeated",type:"string",name:"topics",id:5},{rule:"repeated",type:"string",name:"subtopics",id:6},{rule:"optional",type:"JsonObjectMessage",name:"results",id:7}]},{name:"BlacklistCommand",syntax:"proto2",fields:[{rule:"optional",type:"string",name:"srcCid",id:1},{rule:"repeated",type:"string",name:"toPids",id:2},{rule:"optional",type:"string",name:"srcPid",id:3},{rule:"repeated",type:"string",name:"toCids",id:4},{rule:"optional",type:"int32",name:"limit",id:5},{rule:"optional",type:"string",name:"next",id:6},{rule:"repeated",type:"string",name:"blockedPids",id:8},{rule:"repeated",type:"string",name:"blockedCids",id:9},{rule:"repeated",type:"string",name:"allowedPids",id:10},{rule:"repeated",type:"ErrorCommand",name:"failedPids",id:11},{rule:"optional",type:"int64",name:"t",id:12},{rule:"optional",type:"string",name:"n",id:13},{rule:"optional",type:"string",name:"s",id:14}]},{name:"GenericCommand",syntax:"proto2",fields:[{rule:"optional",type:"CommandType",name:"cmd",id:1},{rule:"optional",type:"OpType",name:"op",id:2},{rule:"optional",type:"string",name:"appId",id:3},{rule:"optional",type:"string",name:"peerId",id:4},{rule:"optional",type:"int32",name:"i",id:5},{rule:"optional",type:"string",name:"installationId",id:6},{rule:"optional",type:"int32",name:"priority",id:7},{rule:"optional",type:"int32",name:"service",id:8},{rule:"optional",type:"int64",name:"serverTs",id:9},{rule:"optional",type:"DataCommand",name:"dataMessage",id:101},{rule:"optional",type:"SessionCommand",name:"sessionMessage",id:102},{rule:"optional",type:"ErrorCommand",name:"errorMessage",id:103},{rule:"optional",type:"DirectCommand",name:"directMessage",id:104},{rule:"optional",type:"AckCommand",name:"ackMessage",id:105},{rule:"optional",type:"UnreadCommand",name:"unreadMessage",id:106},{rule:"optional",type:"ReadCommand",name:"readMessage",id:107},{rule:"optional",type:"RcpCommand",name:"rcpMessage",id:108},{rule:"optional",type:"LogsCommand",name:"logsMessage",id:109},{rule:"optional",type:"ConvCommand",name:"convMessage",id:110},{rule:"optional",type:"RoomCommand",name:"roomMessage",id:111},{rule:"optional",type:"PresenceCommand",name:"presenceMessage",id:112},{rule:"optional",type:"ReportCommand",name:"reportMessage",id:113},{rule:"optional",type:"PatchCommand",name:"patchMessage",id:114},{rule:"optional",type:"PubsubCommand",name:"pubsubMessage",id:115},{rule:"optional",type:"BlacklistCommand",name:"blacklistMessage",id:116}]}],enums:[{name:"CommandType",syntax:"proto2",values:[{name:"session",id:0},{name:"conv",id:1},{name:"direct",id:2},{name:"ack",id:3},{name:"rcp",id:4},{name:"unread",id:5},{name:"logs",id:6},{name:"error",id:7},{name:"login",id:8},{name:"data",id:9},{name:"room",id:10},{name:"read",id:11},{name:"presence",id:12},{name:"report",id:13},{name:"echo",id:14},{name:"loggedin",id:15},{name:"logout",id:16},{name:"loggedout",id:17},{name:"patch",id:18},{name:"pubsub",id:19},{name:"blacklist",id:20},{name:"goaway",id:21}]},{name:"OpType",syntax:"proto2",values:[{name:"open",id:1},{name:"add",id:2},{name:"remove",id:3},{name:"close",id:4},{name:"opened",id:5},{name:"closed",id:6},{name:"query",id:7},{name:"query_result",id:8},{name:"conflict",id:9},{name:"added",id:10},{name:"removed",id:11},{name:"refresh",id:12},{name:"refreshed",id:13},{name:"start",id:30},{name:"started",id:31},{name:"joined",id:32},{name:"members_joined",id:33},{name:"left",id:39},{name:"members_left",id:40},{name:"results",id:42},{name:"count",id:43},{name:"result",id:44},{name:"update",id:45},{name:"updated",id:46},{name:"mute",id:47},{name:"unmute",id:48},{name:"status",id:49},{name:"members",id:50},{name:"max_read",id:51},{name:"is_member",id:52},{name:"member_info_update",id:53},{name:"member_info_updated",id:54},{name:"member_info_changed",id:55},{name:"join",id:80},{name:"invite",id:81},{name:"leave",id:82},{name:"kick",id:83},{name:"reject",id:84},{name:"invited",id:85},{name:"kicked",id:86},{name:"upload",id:100},{name:"uploaded",id:101},{name:"subscribe",id:120},{name:"subscribed",id:121},{name:"unsubscribe",id:122},{name:"unsubscribed",id:123},{name:"is_subscribed",id:124},{name:"modify",id:150},{name:"modified",id:151},{name:"block",id:170},{name:"unblock",id:171},{name:"blocked",id:172},{name:"unblocked",id:173},{name:"members_blocked",id:174},{name:"members_unblocked",id:175},{name:"check_block",id:176},{name:"check_result",id:177},{name:"add_shutup",id:180},{name:"remove_shutup",id:181},{name:"query_shutup",id:182},{name:"shutup_added",id:183},{name:"shutup_removed",id:184},{name:"shutup_result",id:185},{name:"shutuped",id:186},{name:"unshutuped",id:187},{name:"members_shutuped",id:188},{name:"members_unshutuped",id:189},{name:"check_shutup",id:190}]},{name:"StatusType",syntax:"proto2",values:[{name:"on",id:1},{name:"off",id:2}]}],isNamespace:!0}).build(),_messages$push_server=messageCompiled.push_server.messages2,JsonObjectMessage=_messages$push_server.JsonObjectMessage,UnreadTuple=_messages$push_server.UnreadTuple,LogItem=_messages$push_server.LogItem,DataCommand=_messages$push_server.DataCommand,SessionCommand=_messages$push_server.SessionCommand,ErrorCommand=_messages$push_server.ErrorCommand,DirectCommand=_messages$push_server.DirectCommand,AckCommand=_messages$push_server.AckCommand,UnreadCommand=_messages$push_server.UnreadCommand,ConvCommand=_messages$push_server.ConvCommand,RoomCommand=_messages$push_server.RoomCommand,LogsCommand=_messages$push_server.LogsCommand,RcpCommand=_messages$push_server.RcpCommand,ReadTuple=_messages$push_server.ReadTuple,MaxReadTuple=_messages$push_server.MaxReadTuple,ReadCommand=_messages$push_server.ReadCommand,PresenceCommand=_messages$push_server.PresenceCommand,ReportCommand=_messages$push_server.ReportCommand,GenericCommand=_messages$push_server.GenericCommand,BlacklistCommand=_messages$push_server.BlacklistCommand,PatchCommand=_messages$push_server.PatchCommand,PatchItem=_messages$push_server.PatchItem,ConvMemberInfo=_messages$push_server.ConvMemberInfo,CommandType=_messages$push_server.CommandType,OpType=_messages$push_server.OpType,StatusType=_messages$push_server.StatusType,message=Object.freeze({JsonObjectMessage:JsonObjectMessage,UnreadTuple:UnreadTuple,LogItem:LogItem,DataCommand:DataCommand,SessionCommand:SessionCommand,ErrorCommand:ErrorCommand,DirectCommand:DirectCommand,AckCommand:AckCommand,UnreadCommand:UnreadCommand,ConvCommand:ConvCommand,RoomCommand:RoomCommand,LogsCommand:LogsCommand,RcpCommand:RcpCommand,ReadTuple:ReadTuple,MaxReadTuple:MaxReadTuple,ReadCommand:ReadCommand,PresenceCommand:PresenceCommand,ReportCommand:ReportCommand,GenericCommand:GenericCommand,BlacklistCommand:BlacklistCommand,PatchCommand:PatchCommand,PatchItem:PatchItem,ConvMemberInfo:ConvMemberInfo,CommandType:CommandType,OpType:OpType,StatusType:StatusType}),global$1="undefined"!=typeof global?global:"undefined"!=typeof window?window:{},EXPIRED=_Symbol("expired"),debug=d("LC:Expirable"),Expirable=function(){function e(t,n){_classCallCheck(this,e),this.originalValue=t,"number"==typeof n&&(this.expiredAt=Date.now()+n)}return _createClass(e,[{key:"value",get:function(){var e=this.expiredAt&&this.expiredAt<=Date.now();return e&&debug("expired: "+this.originalValue),e?EXPIRED:this.originalValue}}]),e}();Expirable.EXPIRED=EXPIRED;var _class,debug$1=d("LC:Cache"),Cache=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"anonymous";_classCallCheck(this,e),this.name=t,this._map={}}return e.prototype.get=function(e){var t=this._map[e];if(t){var n=t.value;if(n!==Expirable.EXPIRED)return debug$1("[%s] hit: %s",this.name,e),n;delete this._map[e]}return debug$1("["+this.name+"] missed: "+e),null},e.prototype.set=function(e,t,n){debug$1("[%s] set: %s %o %d",this.name,e,t,n),this._map[e]=new Expirable(t,n)},e}(),tryAll=function e(t){var n=new _Promise(t[0]);return 1===t.length?n:n.catch((function(){return e(t.slice(1))}))},tap=function(e){return function(t){return e(t),t}},finalize=function(e){return[function(t){return e(),t},function(t){throw e(),t}]},decodeDate=function(e){return e?"string"==typeof e||"number"==typeof e?new Date(e):"Date"===e.__type&&e.iso?new Date(e.iso):"function"==typeof e.toNumber?new Date(e.toNumber()):e:e},getTime=function(e){return e&&e.getTime?e.getTime():void 0},decode=function e(t){return t?"Date"===t.__type&&t.iso?new Date(t.iso):Array.isArray(t)?t.map(e):isPlainObject(t)?_Object$keys(t).reduce((function(n,r){return _extends({},n,_defineProperty({},r,e(t[r])))}),{}):t:t},encode=function e(t){return t instanceof Date?{__type:"Date",iso:t.toJSON()}:Array.isArray(t)?t.map(e):isPlainObject(t)?_Object$keys(t).reduce((function(n,r){return _extends({},n,_defineProperty({},r,e(t[r])))}),{}):t},keyRemap=function(e,t){return _Object$keys(t).reduce((function(n,r){var s=e[r]||r;return _Object$assign(n,_defineProperty({},s,t[r]))}),{})},isIE10=global$1.navigator&&global$1.navigator.userAgent&&-1!==global$1.navigator.userAgent.indexOf("MSIE 10."),getStaticProperty=function e(t,n){return t[n]||(t.__proto__?e(t.__proto__,n):void 0)},union=function(e,t){return _Array$from(new _Set([].concat(_toConsumableArray(e),_toConsumableArray(t))))},difference=function(e,t){return _Array$from((n=new _Set(t),new _Set(e.filter((function(e){return!n.has(e)})))));var n},map=new _WeakMap,internal=function(e){return map.has(e)||map.set(e,{}),map.get(e)},compact=function e(t,n){if(!isPlainObject(t))return t;var r=_Object$assign({},t);for(var s in r)if({}.hasOwnProperty.call(r,s)){var i=r[s];i===n?delete r[s]:r[s]=e(i,n)}return r},removeNull=function(e){return compact(e,null)},trim=function(e){return removeNull(JSON.parse(_JSON$stringify(e)))},ensureArray=function(e){return Array.isArray(e)?e:null==e?[]:[e]},setValue=function(e,t,n){var r=t.split("."),s=r.pop(),i=e;return r.forEach((function(e){void 0===i[e]&&(i[e]={}),i=i[e]})),i[s]=n,e},isWeapp="object"===("undefined"==typeof wx?"undefined":_typeof(wx))&&"function"==typeof wx.connectSocket,throttle=function(e){return function(t,n,r){var s=r.value;if(s.length)throw new Error("throttled function should not accept any arguments");return _extends({},r,{value:function(){var t=this,r=internal(this).throttleMeta;r||(r={},internal(this).throttleMeta=r);var i=r[n];i||(i={},r[n]=i);var a=i,o=a.previouseTimestamp,u=void 0===o?0:o,c=a.timeout,p=Date.now(),d=e-(p-u);d<=0?(r[n].previouseTimestamp=p,s.apply(this)):c||(i.timeout=setTimeout((function(){i.previouseTimestamp=Date.now(),delete i.timeout,s.apply(t)}),d))}})}};function _applyDecoratedDescriptor(e,t,n,r,s){var i={};return Object.keys(r).forEach((function(e){i[e]=r[e]})),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=n.slice().reverse().reduce((function(n,r){return r(e,t,n)||n}),i),s&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(s):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(e,t,i),i=null),i}var debug$2=d("LC:WebSocketPlus"),OPEN="open",DISCONNECT="disconnect",RECONNECT="reconnect",RETRY="retry",SCHEDULE="schedule",OFFLINE="offline",ONLINE="online",ERROR="error",MESSAGE="message",HEARTBEAT_TIME=18e4,TIMEOUT_TIME=38e4,DEFAULT_RETRY_STRATEGY=function(e){return Math.min(1e3*Math.pow(2,e),3e5)},requireConnected=function(e,t,n){return _Object$assign({},n,{value:function(){var e;this.checkConnectionAvailability(t);for(var r=arguments.length,s=Array(r),i=0;i<r;i++)s[i]=arguments[i];return(e=n.value).call.apply(e,[this].concat(s))}})},WebSocketPlus=(_class=function(e){function t(n,r){if(_classCallCheck(this,t),void 0===WebSocket)throw new Error("WebSocket is undefined. Polyfill is required in this runtime.");var s=_possibleConstructorReturn(this,e.call(this));return s.init(),s._protocol=r,_Promise.resolve("function"==typeof n?n():n).then(ensureArray).then((function(e){return s._urls=e,s._open()})).then((function(){s.__postponeTimeoutTimer=s._postponeTimeoutTimer.bind(s),global$1.addEventListener&&(s.__pause=function(){s.can("pause")&&s.pause()},s.__resume=function(){s.can("resume")&&s.resume()},global$1.addEventListener("offline",s.__pause),global$1.addEventListener("online",s.__resume)),s.open()})).catch(s.throw.bind(s)),s}return _inherits(t,e),_createClass(t,[{key:"urls",get:function(){return this._urls},set:function(e){this._urls=ensureArray(e)}}]),t.prototype._open=function(){var e=this;return this._createWs(this._urls,this._protocol).then((function(t){var n=_toArray(e._urls),r=n[0],s=n.slice(1);return e._urls=[].concat(_toConsumableArray(s),[r]),t}))},t.prototype._createWs=function(e,t){var n=this;return tryAll(e.map((function(e){return function(r,s){debug$2("connect ["+e+"] "+t);var i=t?new WebSocket(e,t):new WebSocket(e);i.binaryType=n.binaryType||"arraybuffer",i.onopen=function(){return r(i)},i.onclose=function(t){return t instanceof Error?s(t):s(new Error("Failed to connect ["+e+"]"))},i.onerror=i.onclose}}))).then((function(e){return n._ws=e,n._ws.onclose=n._handleClose.bind(n),n._ws.onmessage=n._handleMessage.bind(n),e}))},t.prototype._destroyWs=function(){var e=this._ws;e&&(e.onopen=null,e.onclose=null,e.onerror=null,e.onmessage=null,this._ws=null,e.close())},t.prototype.onbeforeevent=function(e,t,n){for(var r=arguments.length,s=Array(r>3?r-3:0),i=3;i<r;i++)s[i-3]=arguments[i];debug$2.apply(void 0,[e+": "+t+" -> "+n].concat(s))},t.prototype.onopen=function(){this.emit(OPEN)},t.prototype.onconnected=function(){this._startConnectionKeeper()},t.prototype.onleaveconnected=function(e,t,n){this._stopConnectionKeeper(),this._destroyWs(),"offline"!==n&&"disconnected"!==n||this.emit(DISCONNECT)},t.prototype.onpause=function(){this.emit(OFFLINE)},t.prototype.onbeforeresume=function(){this.emit(ONLINE)},t.prototype.onreconnect=function(){this.emit(RECONNECT)},t.prototype.ondisconnected=function(e,t,n){var r=this,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=DEFAULT_RETRY_STRATEGY.call(null,s);debug$2("schedule attempt="+s+" delay="+i),this.emit(SCHEDULE,s,i),this.__scheduledRetry&&clearTimeout(this.__scheduledRetry),this.__scheduledRetry=setTimeout((function(){r.is("disconnected")&&r.retry(s)}),i)},t.prototype.onretry=function(e,t,n){var r=this,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this.emit(RETRY,s),this._open().then((function(){return r.can("reconnect")?r.reconnect():r._destroyWs()}),(function(){return r.can("fail")&&r.fail(s+1)}))},t.prototype.onerror=function(e,t,n,r){this.emit(ERROR,r)},t.prototype.onclose=function(){global$1.removeEventListener&&(this.__pause&&global$1.removeEventListener("offline",this.__pause),this.__resume&&global$1.removeEventListener("online",this.__resume))},t.prototype.checkConnectionAvailability=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"API";if(!this.is("connected")){var t=this.current;throw console.warn(e+" should not be called when the connection is "+t),(this.is("disconnected")||this.is("reconnecting"))&&console.warn("disconnect and reconnect event should be handled to avoid such calls."),new Error("Connection unavailable")}},t.prototype._ping=function(){debug$2("ping");try{this.ping()}catch(e){console.warn("websocket ping error: "+e.message)}},t.prototype.ping=function(){this._ws.ping?this._ws.ping():console.warn("The WebSocket implement does not support sending ping frame.\n        Override ping method to use application defined ping/pong mechanism.")},t.prototype._postponeTimeoutTimer=function(){var e=this;debug$2("_postponeTimeoutTimer"),this._clearTimeoutTimers(),this._timeoutTimer=setTimeout((function(){debug$2("timeout"),e.disconnect()}),TIMEOUT_TIME)},t.prototype._clearTimeoutTimers=function(){this._timeoutTimer&&clearTimeout(this._timeoutTimer)},t.prototype._startConnectionKeeper=function(){debug$2("start connection keeper"),this._heartbeatTimer=setInterval(this._ping.bind(this),HEARTBEAT_TIME);var e=this._ws.addListener||this._ws.addEventListener;e.call(this._ws,"message",this.__postponeTimeoutTimer),e.call(this._ws,"pong",this.__postponeTimeoutTimer),this._postponeTimeoutTimer()},t.prototype._stopConnectionKeeper=function(){debug$2("stop connection keeper");var e=this._ws.removeListener||this._ws.removeEventListener;e.call(this._ws,"message",this.__postponeTimeoutTimer),e.call(this._ws,"pong",this.__postponeTimeoutTimer),this._clearTimeoutTimers(),this._heartbeatTimer&&clearInterval(this._heartbeatTimer)},t.prototype._handleClose=function(e){debug$2("ws closed ["+e.code+"] "+e.reason),this.isFinished()||this.handleClose(e)},t.prototype.handleClose=function(){this.disconnect()},t.prototype.send=function(e){debug$2("send",e),this._ws.send(e)},t.prototype._handleMessage=function(e){debug$2("message",e.data),this.handleMessage(e.data)},t.prototype.handleMessage=function(e){this.emit(MESSAGE,e)},t}(EventEmitter),_applyDecoratedDescriptor(_class.prototype,"_ping",[requireConnected],_Object$getOwnPropertyDescriptor(_class.prototype,"_ping"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"send",[requireConnected],_Object$getOwnPropertyDescriptor(_class.prototype,"send"),_class.prototype),_class);StateMachine.create({target:WebSocketPlus.prototype,initial:{state:"initialized",event:"init",defer:!0},terminal:"closed",events:[{name:"open",from:"initialized",to:"connected"},{name:"disconnect",from:"connected",to:"disconnected"},{name:"retry",from:"disconnected",to:"reconnecting"},{name:"fail",from:"reconnecting",to:"disconnected"},{name:"reconnect",from:"reconnecting",to:"connected"},{name:"pause",from:["connected","disconnected","reconnecting"],to:"offline"},{},{name:"resume",from:"offline",to:"disconnected"},{name:"close",from:["connected","disconnected","reconnecting","offline"],to:"closed"},{name:"throw",from:"*",to:"error"}]});var _rMessageStatus,error=_Object$freeze({1e3:{name:"CLOSE_NORMAL"},1006:{name:"CLOSE_ABNORMAL"},4100:{name:"APP_NOT_AVAILABLE",message:"App not exists or realtime message service is disabled."},4102:{name:"SIGNATURE_FAILED",message:"Login signature mismatch."},4103:{name:"INVALID_LOGIN",message:"Malformed clientId."},4105:{name:"SESSION_REQUIRED",message:"Message sent before session opened."},4107:{name:"READ_TIMEOUT"},4108:{name:"LOGIN_TIMEOUT"},4109:{name:"FRAME_TOO_LONG"},4110:{name:"INVALID_ORIGIN",message:"Access denied by domain whitelist."},4111:{name:"SESSION_CONFLICT"},4112:{name:"SESSION_TOKEN_EXPIRED"},4113:{name:"APP_QUOTA_EXCEEDED",message:"The daily active users limit exceeded."},4116:{name:"MESSAGE_SENT_QUOTA_EXCEEDED",message:"Command sent too fast."},4200:{name:"INTERNAL_ERROR",message:"Internal error, please contact LeanCloud for support."},4301:{name:"CONVERSATION_API_FAILED",message:"Upstream Conversatoin API failed, see error.detail for details."},4302:{name:"CONVERSATION_SIGNATURE_FAILED",message:"Conversation action signature mismatch."},4303:{name:"CONVERSATION_NOT_FOUND"},4304:{name:"CONVERSATION_FULL"},4305:{name:"CONVERSATION_REJECTED_BY_APP",message:"Conversation action rejected by hook."},4306:{name:"CONVERSATION_UPDATE_FAILED"},4307:{name:"CONVERSATION_READ_ONLY"},4308:{name:"CONVERSATION_NOT_ALLOWED"},4309:{name:"CONVERSATION_UPDATE_REJECTED",message:"Conversation update rejected because the client is not a member."},4310:{name:"CONVERSATION_QUERY_FAILED",message:"Conversation query failed because it is too expansive."},4311:{name:"CONVERSATION_LOG_FAILED"},4312:{name:"CONVERSATION_LOG_REJECTED",message:"Message query rejected because the client is not a member of the conversation."},4313:{name:"SYSTEM_CONVERSATION_REQUIRED"},4314:{name:"NORMAL_CONVERSATION_REQUIRED"},4315:{name:"CONVERSATION_BLACKLISTED",message:"Blacklisted in the conversation."},4316:{name:"TRANSIENT_CONVERSATION_REQUIRED"},4317:{name:"CONVERSATION_MEMBERSHIP_REQUIRED"},4318:{name:"CONVERSATION_API_QUOTA_EXCEEDED",message:"LeanCloud API quota exceeded. You may upgrade your plan."},4323:{name:"TEMPORARY_CONVERSATION_EXPIRED",message:"Temporary conversation expired or does not exist."},4401:{name:"INVALID_MESSAGING_TARGET",message:"Conversation does not exist or client is not a member."},4402:{name:"MESSAGE_REJECTED_BY_APP",message:"Message rejected by hook."},4403:{name:"MESSAGE_OWNERSHIP_REQUIRED"},4404:{name:"MESSAGE_NOT_FOUND"},4405:{name:"MESSAGE_UPDATE_REJECTED_BY_APP",message:"Message update rejected by hook."},4406:{name:"MESSAGE_EDIT_DISABLED"},4407:{name:"MESSAGE_RECALL_DISABLED"},5130:{name:"OWNER_PROMOTION_NOT_ALLOWED",message:"Updating a member's role to owner is not allowed."}}),ErrorCode=_Object$freeze(_Object$keys(error).reduce((function(e,t){return _Object$assign(e,_defineProperty({},error[t].name,Number(t)))}),{})),createError=function(e){var t=e.code,n=e.reason,r=e.appCode,s=e.detail,i=e.error,a=n||s||i,o=n;!a&&error[t]&&(o=error[t].name,a=error[t].message||o),a||(a="Unknow Error: "+t);var u=new Error(a);return _Object$assign(u,{code:t,appCode:r,detail:s,name:o})},debug$3=d("LC:Connection"),COMMAND_TIMEOUT=2e4,EXPIRE=_Symbol("expire"),Connection=function(e){function t(n,r){var s=r.format,i=r.version;_classCallCheck(this,t),debug$3("initializing Connection");var a="lc."+s+"."+i;if(isWeapp)o=_possibleConstructorReturn(this,e.call(this,n().then((function(e){return e.map((function(e){return e+(-1===e.indexOf("?")?"?":"&")+"subprotocol="+encodeURIComponent(a)}))}))));else var o=_possibleConstructorReturn(this,e.call(this,n,a));return o._protocalFormat=s,o._commands={},o._serialId=0,_possibleConstructorReturn(o)}var n;return _inherits(t,e),t.prototype.send=(n=_asyncToGenerator(_regeneratorRuntime.mark((function t(n){var r,s,i=this,a=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return _regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=void 0,a&&(this._serialId+=1,r=this._serialId,n.i=r),debug$3.enabled&&debug$3("↑ %O sent",trim(n)),s=void 0,"proto2base64"===this._protocalFormat?s=n.toBase64():n.toArrayBuffer&&(s=n.toArrayBuffer()),s){t.next=7;break}throw new TypeError(n+" is not a GenericCommand");case 7:if(e.prototype.send.call(this,s),a){t.next=10;break}return t.abrupt("return",void 0);case 10:return t.abrupt("return",new _Promise((function(e,t){i._commands[r]={resolve:e,reject:t,timeout:setTimeout((function(){i._commands[r]&&(debug$3.enabled&&debug$3("✗ %O timeout",trim(n)),t(createError({error:"Command Timeout [cmd:"+n.cmd+" op:"+n.op+"]",name:"COMMAND_TIMEOUT"})),delete i._commands[r])}),COMMAND_TIMEOUT)}})));case 11:case"end":return t.stop()}}),t,this)}))),function(e){return n.apply(this,arguments)}),t.prototype.handleMessage=function(e){var t=void 0;try{t=GenericCommand.decode(e),debug$3.enabled&&debug$3("↓ %O received",trim(t))}catch(t){return void console.warn("Decode message failed:",t.message,e)}var n=t.i;if(n)this._commands[n]?(clearTimeout(this._commands[n].timeout),t.cmd===CommandType.error?this._commands[n].reject(createError(t.errorMessage)):this._commands[n].resolve(t),delete this._commands[n]):console.warn("Unexpected command received with serialId ["+n+"],\n         which have timed out or never been requested.");else switch(t.cmd){case CommandType.error:return void this.emit(ERROR,createError(t.errorMessage));case CommandType.goaway:return void this.emit(EXPIRE);default:this.emit(MESSAGE,t)}},t.prototype.ping=function(){return this.send(new GenericCommand({cmd:CommandType.echo})).catch((function(e){return debug$3("ping failed:",e)}))},t}(WebSocketPlus),checkType=function(e){return function(t){var n=t.constructor;return _Promise.resolve(t).then(e).then(tap((function(r){return null==r?console.warn("Middleware["+(e._pluginName||"anonymous plugin")+":"+(e.name||"anonymous middleware")+"] param/return types not match. It returns "+r+" while a "+t.constructor.name+" expected."):r instanceof n?0:console.warn("Middleware["+(e._pluginName||"anonymous plugin")+":"+(e.name||"anonymous middleware")+"] param/return types not match. It returns a "+r.constructor.name+" while a "+t.constructor.name+" expected.")})))}},applyDecorators=function(e,t){e&&e.forEach((function(e){try{e(t)}catch(t){throw e._pluginName&&(t.message+="["+e._pluginName+"]"),t}}))},applyMiddlewares=function(e){return function(t){return ensureArray(e).reduce((function(e,t){return e.then(checkType(t)).catch((function(e){throw t._pluginName&&(e.message+="["+t._pluginName+"]"),e}))}),_Promise.resolve(t))}},applyDispatcher=function(e,t){return ensureArray(e).reduce((function(e,n){return e.then((function(e){return!1!==e&&n.apply(void 0,_toConsumableArray(t))})).catch((function(e){throw n._pluginName&&(e.message+="["+n._pluginName+"]"),e}))}),_Promise.resolve(!0))},version="4.3.0",debug$4=d("LC:Realtime"),debugRequest=d("LC:request"),routerCache=new Cache("push-router"),Realtime=function(e){function t(n){var r=n.plugins,s=_objectWithoutProperties(n,["plugins"]);_classCallCheck(this,t),debug$4("initializing Realtime %s %O",version,s);var i=_possibleConstructorReturn(this,e.call(this));if("string"!=typeof s.appId)throw new TypeError("appId ["+s.appId+"] is not a string");if("string"!=typeof s.appKey)throw new TypeError("appKey ["+s.appKey+"] is not a string");i._options=_Object$assign({appId:void 0,appKey:void 0,pushOfflineMessages:!1,noBinary:!1,ssl:!0,RTMServerName:process.env.RTM_SERVER_NAME},s),i._cache=new Cache("endpoints");var a=internal(i);a.clients=new _Set,a.pendingClients=new _Set;var o=[].concat(_toConsumableArray(ensureArray(t.__preRegisteredPlugins)),_toConsumableArray(ensureArray(r)));return debug$4("Using plugins %o",o.map((function(e){return e.name}))),i._plugins=o.reduce((function(e,t){for(var n in t)({}).hasOwnProperty.call(t,n)&&"name"!==n&&(t.name&&ensureArray(t[n]).forEach((function(e){e._pluginName=t.name})),e[n]=ensureArray(e[n]).concat(t[n]));return e}),{}),applyDecorators(i._plugins.onRealtimeCreate,i),i}var n,r,s;return _inherits(t,e),t.prototype._request=(n=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s,i,a,o,u,c=t.method,p=t.version,d=void 0===p?"1.1":p,m=t.path,l=t.query,h=t.headers,_=t.data,f=void 0===_?{}:_;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._options,r=n.appId,s=n.server,e.next=3,this.constructor._getServerUrls({appId:r,server:s});case 3:return i=e.sent,a=i.api,o="https://"+a+"/"+d+m,u={method:c,params:l,headers:_extends({"X-LC-Id":this._options.appId,"X-LC-Key":this._options.appKey},h),data:f},debugRequest("Req: %O %O",o,u),e.abrupt("return",axios(o,u).then((function(e){return debugRequest("Res: %O %O %O",o,e.status,e.data),e.data}),(function(e){if(debugRequest("Error: %O %O %O",o,e.response.status,e.response.data),e.response&&e.response.data&&e.response.data.code)throw createError(e.response.data);throw e})));case 9:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)}),t.prototype._open=function(){var e=this;if(this._openPromise)return this._openPromise;var t="protobuf2";this._options.noBinary&&(t="proto2base64");var n=3;this._options.pushOfflineMessages&&(n=1);var r={format:t,version:n};return this._openPromise=new _Promise((function(t,n){debug$4("No connection established, create a new one.");var s=new Connection((function(){return e._getRTMServers(e._options)}),r);s.on(OPEN,(function(){return t(s)})).on(ERROR,n).on(EXPIRE,_asyncToGenerator(_regeneratorRuntime.mark((function t(){return _regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return debug$4("Connection expired. Refresh endpoints."),e._cache.set("endpoints",null,0),t.next=4,e._getRTMServers(e._options);case 4:s.urls=t.sent,s.disconnect();case 6:case"end":return t.stop()}}),t,e)})))).on(MESSAGE,e._dispatchCommand.bind(e)),[DISCONNECT,RECONNECT,RETRY,SCHEDULE,OFFLINE,ONLINE].forEach((function(t){return s.on(t,(function(){for(var n=arguments.length,r=Array(n),s=0;s<n;s++)r[s]=arguments[s];debug$4(t+" event emitted. %o",r),e.emit.apply(e,[t].concat(r)),t!==RECONNECT&&internal(e).clients.forEach((function(e){e.emit.apply(e,[t].concat(r))}))}))})),s.handleClose=function(e){[ErrorCode.APP_NOT_AVAILABLE,ErrorCode.INVALID_LOGIN,ErrorCode.INVALID_ORIGIN].some((function(t){return t===e.code}))?this.throw(createError(e)):this.disconnect()},internal(e).connection=s})),this._openPromise},t.prototype._getRTMServers=(r=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.RTMServers){e.next=2;break}return e.abrupt("return",shuffle(ensureArray(t.RTMServers)));case 2:if(n=void 0,!(r=this._cache.get("endpoints"))){e.next=10;break}return e.next=7,r;case 7:n=e.sent,e.next=14;break;case 10:return e.next=12,this.constructor._fetchRTMServers(t);case 12:n=e.sent,this._cache.set("endpoints",n,1e3*n.ttl);case 14:return debug$4("endpoint info: %O",n),e.abrupt("return",[n.server,n.secondary]);case 16:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)}),t._getServerUrls=(s=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r=t.appId,s=t.server;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(debug$4("fetch server urls"),!s){e.next=5;break}if("string"==typeof s){e.next=4;break}return e.abrupt("return",s);case 4:return e.abrupt("return",{RTMRouter:s,api:s});case 5:if(!(n=routerCache.get(r))){e.next=8;break}return e.abrupt("return",n);case 8:return e.abrupt("return",axios.get("https://app-router.leancloud.cn/2/route",{params:{appId:r},timeout:2e4}).then((function(e){return e.data})).then(tap(debug$4)).then((function(e){var t=e.rtm_router_server,n=e.api_server,s=e.ttl,i=void 0===s?3600:s;if(!t)throw new Error("rtm router not exists");var a={RTMRouter:t,api:n};return routerCache.set(r,a,1e3*i),a})).catch((function(){var e=r.slice(0,8).toLowerCase();return{RTMRouter:e+".rtm.lncld.net",api:e+".api.lncld.net"}})));case 9:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)}),t._fetchRTMServers=function(e){var t=e.appId,n=e.ssl,r=e.server,s=e.RTMServerName;return debug$4("fetch endpoint info"),this._getServerUrls({appId:t,server:r}).then(tap(debug$4)).then((function(e){var r=e.RTMRouter;return axios.get("https://"+r+"/v1/route",{params:{appId:t,secure:n,features:isWeapp?"wechat":void 0,server:s,_t:Date.now()},timeout:2e4}).then((function(e){return e.data})).then(tap(debug$4))}))},t.prototype._close=function(){this._openPromise&&this._openPromise.then((function(e){return e.close()})),delete this._openPromise},t.prototype.retry=function(){var e=internal(this).connection;if(!e)throw new Error("no connection established");if(e.cannot("retry"))throw new Error("retrying not allowed when not disconnected. the connection is now "+e.current);return e.retry()},t.prototype.pause=function(){var e=internal(this).connection;e&&e.can("pause")&&e.pause()},t.prototype.resume=function(){var e=internal(this).connection;e&&e.can("resume")&&e.resume()},t.prototype._registerPending=function(e){internal(this).pendingClients.add(e)},t.prototype._deregisterPending=function(e){internal(this).pendingClients.delete(e)},t.prototype._register=function(e){internal(this).clients.add(e)},t.prototype._deregister=function(e){var t=internal(this);t.clients.delete(e),t.clients.size+t.pendingClients.size===0&&this._close()},t.prototype._dispatchCommand=function(e){return applyDispatcher(this._plugins.beforeCommandDispatch,[e,this]).then((function(t){return!!t&&debug$4("[WARN] Unexpected message received: %O",trim(e))}))},t}(EventEmitter),UNREAD_MESSAGES_COUNT_UPDATE="unreadmessagescountupdate",CLOSE="close",CONFLICT="conflict",CONVERSATION_INFO_UPDATED="conversationinfoupdated",UNHANDLED_MESSAGE="unhandledmessage",INVITED="invited",KICKED="kicked",MEMBERS_JOINED="membersjoined",MEMBERS_LEFT="membersleft",MEMBER_INFO_UPDATED="memberinfoupdated",BLOCKED="blocked",UNBLOCKED="unblocked",MEMBERS_BLOCKED="membersblocked",MEMBERS_UNBLOCKED="membersunblocked",MUTED="muted",UNMUTED="unmuted",MEMBERS_MUTED="membersmuted",MEMBERS_UNMUTED="membersunmuted",MESSAGE$1="message",MESSAGE_RECALL="messagerecall",MESSAGE_UPDATE="messageupdate",LAST_DELIVERED_AT_UPDATE="lastdeliveredatupdate",LAST_READ_AT_UPDATE="lastreadatupdate",INFO_UPDATED="infoupdated",Event=Object.freeze({UNREAD_MESSAGES_COUNT_UPDATE:UNREAD_MESSAGES_COUNT_UPDATE,CLOSE:CLOSE,CONFLICT:CONFLICT,CONVERSATION_INFO_UPDATED:CONVERSATION_INFO_UPDATED,UNHANDLED_MESSAGE:UNHANDLED_MESSAGE,INVITED:INVITED,KICKED:KICKED,MEMBERS_JOINED:MEMBERS_JOINED,MEMBERS_LEFT:MEMBERS_LEFT,MEMBER_INFO_UPDATED:MEMBER_INFO_UPDATED,BLOCKED:BLOCKED,UNBLOCKED:UNBLOCKED,MEMBERS_BLOCKED:MEMBERS_BLOCKED,MEMBERS_UNBLOCKED:MEMBERS_UNBLOCKED,MUTED:MUTED,UNMUTED:UNMUTED,MEMBERS_MUTED:MEMBERS_MUTED,MEMBERS_UNMUTED:MEMBERS_UNMUTED,MESSAGE:MESSAGE$1,MESSAGE_RECALL:MESSAGE_RECALL,MESSAGE_UPDATE:MESSAGE_UPDATE,LAST_DELIVERED_AT_UPDATE:LAST_DELIVERED_AT_UPDATE,LAST_READ_AT_UPDATE:LAST_READ_AT_UPDATE,INFO_UPDATED:INFO_UPDATED}),MessageStatus={NONE:_Symbol("none"),SENDING:_Symbol("sending"),SENT:_Symbol("sent"),DELIVERED:_Symbol("delivered"),FAILED:_Symbol("failed")};_Object$freeze(MessageStatus);var _dec,_class$1,_dec$1,_class$2,rMessageStatus=(_defineProperty(_rMessageStatus={},MessageStatus.NONE,!0),_defineProperty(_rMessageStatus,MessageStatus.SENDING,!0),_defineProperty(_rMessageStatus,MessageStatus.SENT,!0),_defineProperty(_rMessageStatus,MessageStatus.DELIVERED,!0),_defineProperty(_rMessageStatus,MessageStatus.READ,!0),_defineProperty(_rMessageStatus,MessageStatus.FAILED,!0),_rMessageStatus),Message=function(){function e(t){_classCallCheck(this,e),_Object$assign(this,{content:t},{id:uuid(),cid:null,timestamp:new Date,from:void 0,mentionList:[],mentionedAll:!1,_mentioned:!1}),this._setStatus(MessageStatus.NONE)}return e.prototype.getPayload=function(){return this.content},e.prototype._toJSON=function(){return{id:this.id,cid:this.cid,from:this.from,timestamp:this.timestamp,deliveredAt:this.deliveredAt,updatedAt:this.updatedAt,mentionList:this.mentionList,mentionedAll:this.mentionedAll,mentioned:this.mentioned}},e.prototype.toJSON=function(){return _extends({},this._toJSON(),{data:this.content})},e.prototype.toFullJSON=function(){var e=this.content,t=this.id,n=this.cid,r=this.from,s=this.timestamp,i=this.deliveredAt,a=this._updatedAt,o=this.mentionList,u=this.mentionedAll;return{data:e,id:t,cid:n,from:r,timestamp:getTime(s),deliveredAt:getTime(i),updatedAt:getTime(a),mentionList:o,mentionedAll:u}},e.prototype._setStatus=function(e){if(!rMessageStatus[e])throw new Error("Invalid message status");this._status=e},e.prototype._updateMentioned=function(e){this._mentioned=this.from!==e&&(this.mentionedAll||this.mentionList.indexOf(e)>-1)},e.prototype.getMentionList=function(){return this.mentionList},e.prototype.setMentionList=function(e){return this.mentionList=ensureArray(e),this},e.prototype.mentionAll=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this.mentionedAll=Boolean(e),this},e.validate=function(){return!0},e.parse=function(e,t){return t||new this(e)},_createClass(e,[{key:"status",get:function(){return this._status}},{key:"timestamp",get:function(){return this._timestamp},set:function(e){this._timestamp=decodeDate(e)}},{key:"deliveredAt",get:function(){return this._deliveredAt},set:function(e){this._deliveredAt=decodeDate(e)}},{key:"updatedAt",get:function(){return this._updatedAt||this.timestamp},set:function(e){this._updatedAt=decodeDate(e)}},{key:"mentioned",get:function(){return this._mentioned}}]),e}(),messageType=function(e){if("number"!=typeof e)throw new TypeError(e+" is not a Number");return function(t){t.TYPE=e,t.validate=function(t){return t._lctype===e},t.prototype._getType=function(){return{_lctype:e}}}},messageField=function(e){if("string"!=typeof e){if(!Array.isArray(e))throw new TypeError(e+" is not an Array");if(e.some((function(e){return"string"!=typeof e})))throw new TypeError("fields contains non-string typed member")}return function(t){var n=isIE10?getStaticProperty(t,"_customFields"):t._customFields;n=Array.isArray(n)?n:[],t._customFields=n.concat(e)}},IE10Compatible=function(e){isIE10&&(e.parse=getStaticProperty(e,"parse"))},TypedMessage=(_dec=messageField(["_lctext","_lcattrs"]))(_class$1=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,e.apply(this,arguments))}return _inherits(t,e),t.prototype.setText=function(e){return this._lctext=e,this},t.prototype.getText=function(){return this._lctext},t.prototype.setAttributes=function(e){return this._lcattrs=e,this},t.prototype.getAttributes=function(){return this._lcattrs},t.prototype._getCustomFields=function(){var e=this;return(Array.isArray(this.constructor._customFields)?this.constructor._customFields:[]).reduce((function(t,n){return"string"!=typeof n||(t[n]=e[n]),t}),{})},t.prototype._getType=function(){throw new Error("not implemented")},t.prototype.getPayload=function(){return compact(_Object$assign({_lctext:this.getText(),_lcattrs:this.getAttributes()},this._getCustomFields(),this._getType()))},t.prototype.toJSON=function(){var t=this.type,n=this.text,r=this.attributes,s=this.summary;return _extends({},e.prototype._toJSON.call(this),{type:t,text:n,attributes:r,summary:s})},t.prototype.toFullJSON=function(){return _extends({},e.prototype.toFullJSON.call(this),{data:this.getPayload()})},t.parse=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new this;n.content=t;var r=isIE10?getStaticProperty(n.constructor,"_customFields"):n.constructor._customFields,s=Array.isArray(r)?r:[];return s=s.reduce((function(e,n){return"string"!=typeof n||(e[n]=t[n]),e}),{}),_Object$assign(n,s),e.parse.call(this,t,n)},_createClass(t,[{key:"type",get:function(){return this.constructor.TYPE}},{key:"text",set:function(e){return this.setText(e)},get:function(){return this.getText()}},{key:"attributes",set:function(e){return this.setAttributes(e)},get:function(){return this.getAttributes()}},{key:"summary",get:function(){return this.text}}]),t}(Message))||_class$1,RecalledMessage=(_dec$1=messageType(-127))(_class$2=IE10Compatible(_class$2=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,e.apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"summary",get:function(){return"[该消息已撤回]"}}]),t}(TypedMessage))||_class$2)||_class$2,debug$5=d("LC:Conversation"),serializeMessage=function(e){var t=e.getPayload(),n=void 0,r=void 0;return t instanceof ArrayBuffer?r=t:n="string"!=typeof t?_JSON$stringify(t):t,{msg:n,binaryMsg:r}},_LogsCommand$QueryDir=LogsCommand.QueryDirection,NEW=_LogsCommand$QueryDir.NEW,OLD=_LogsCommand$QueryDir.OLD,MessageQueryDirection={NEW_TO_OLD:OLD,OLD_TO_NEW:NEW};_Object$freeze(MessageQueryDirection);var ConversationBase=function(e){function t(n,r){var s=n.id,i=n.lastMessageAt,a=n.lastMessage,o=n.lastDeliveredAt,u=n.lastReadAt,c=n.unreadMessagesCount,p=void 0===c?0:c,d=n.members,m=void 0===d?[]:d,l=n.mentioned,h=void 0!==l&&l,_=_objectWithoutProperties(n,["id","lastMessageAt","lastMessage","lastDeliveredAt","lastReadAt","unreadMessagesCount","members","mentioned"]);_classCallCheck(this,t);var f=_possibleConstructorReturn(this,e.call(this));return _Object$assign(f,_extends({id:s,lastMessageAt:i,lastMessage:a,members:m},_)),f.members=_Array$from(new _Set(f.members)),_Object$assign(internal(f),{messagesWaitingForReceipt:{},lastDeliveredAt:o,lastReadAt:u,unreadMessagesCount:p,mentioned:h}),f._client=r,debug$5.enabled&&_Object$values(Event).forEach((function(e){return f.on(e,(function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];return f._debug(e+" event emitted. %o",n)}))})),applyDecorators(f._client._plugins.onConversationCreate,f),f}var n,r,s,i,a,o,u,c;return _inherits(t,e),t.prototype._setUnreadMessagesMentioned=function(e){internal(this).unreadMessagesMentioned=Boolean(e)},t.prototype._setLastDeliveredAt=function(e){var t=decodeDate(e);t<internal(this).lastDeliveredAt||(internal(this).lastDeliveredAt=t,this.emit(LAST_DELIVERED_AT_UPDATE))},t.prototype._setLastReadAt=function(e){var t=decodeDate(e);t<internal(this).lastReadAt||(internal(this).lastReadAt=t,this.emit(LAST_READ_AT_UPDATE))},t.prototype.toFullJSON=function(){var e=this.id,t=this.members,n=this.lastMessageAt,r=this.lastDeliveredAt,s=this.lastReadAt,i=this.lastMessage,a=this.unreadMessagesCount;return{id:e,members:t,lastMessageAt:getTime(n),lastDeliveredAt:getTime(r),lastReadAt:getTime(s),lastMessage:i?i.toFullJSON():void 0,unreadMessagesCount:a}},t.prototype.toJSON=function(){var e=this.id,t=this.members,n=this.lastMessageAt,r=this.lastDeliveredAt,s=this.lastReadAt,i=this.lastMessage,a=this.unreadMessagesCount,o=this.unreadMessagesMentioned;return{id:e,members:t,lastMessageAt:n,lastDeliveredAt:r,lastReadAt:s,lastMessage:i?i.toJSON():void 0,unreadMessagesCount:a,unreadMessagesMentioned:o}},t.prototype._debug=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];debug$5.apply(void 0,t.concat(["["+this.id+"]"]))},t.prototype._send=function(e){var t;null===e.cmd&&(e.cmd="conv"),"conv"===e.cmd&&null===e.convMessage&&(e.convMessage=new ConvCommand),e.convMessage&&null===e.convMessage.cid&&(e.convMessage.cid=this.id);for(var n=arguments.length,r=Array(n>1?n-1:0),s=1;s<n;s++)r[s-1]=arguments[s];return(t=this._client)._send.apply(t,[e].concat(r))},t.prototype.send=(n=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,n){var r,s,i,a,o,u,c,p,d,m,l,h,_,f,g,y,b;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._debug(t,"send"),t instanceof Message){e.next=3;break}throw new TypeError(t+" is not a Message");case 3:return r=_Object$assign({},t.constructor.sendOptions,"function"==typeof t.constructor.getSendOptions?t.constructor.getSendOptions(t):{},n),s=r.transient,i=r.receipt,a=r.priority,o=r.pushData,u=r.will,i&&(this.transient?console.warn("receipt option is ignored as the conversation is transient."):s?console.warn("receipt option is ignored as the message is sent transiently."):this.members.length>2&&console.warn("receipt option is recommended to be used in one-on-one conversation.")),a&&!this.transient&&console.warn("priority option is ignored as the conversation is not transient."),_Object$assign(t,{cid:this.id,from:this._client.id}),t._setStatus(MessageStatus.SENDING),c=serializeMessage(t),p=c.msg,d=c.binaryMsg,m=new GenericCommand({cmd:"direct",directMessage:new DirectCommand({msg:p,binaryMsg:d,cid:this.id,r:i,transient:s,dt:t.id,pushData:_JSON$stringify(o),will:u,mentionPids:t.mentionList,mentionAll:t.mentionedAll}),priority:a}),e.prev=10,e.next=13,this._send(m);case 13:if(l=e.sent,h=l.ackMessage,_=h.uid,f=h.t,g=h.code,y=h.reason,b=h.appCode,null===g){e.next=17;break}throw createError({code:g,reason:y,appCode:b});case 17:return _Object$assign(t,{id:_,timestamp:f}),s||(this.lastMessage=t,this.lastMessageAt=t.timestamp),t._setStatus(MessageStatus.SENT),i&&(internal(this).messagesWaitingForReceipt[t.id]=t),e.abrupt("return",t);case 24:throw e.prev=24,e.t0=e.catch(10),t._setStatus(MessageStatus.FAILED),e.t0;case 28:case"end":return e.stop()}}),e,this,[[10,24]])}))),function(e,t){return n.apply(this,arguments)}),t.prototype._update=(r=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,n,r){var s,i,a,o,u,c,p,d;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._debug("patch %O %O %O",t,n,r),!(t instanceof Message)){e.next=8;break}if(t.from===this._client.id){e.next=4;break}throw new Error("Updating message from others is not allowed");case 4:if(t.status===MessageStatus.SENT||t.status===MessageStatus.DELIVERED){e.next=6;break}throw new Error("Message is not sent");case 6:e.next=10;break;case 8:if(t.id&&t.timestamp){e.next=10;break}throw new TypeError(t+" is not a Message");case 10:return s=void 0,i=void 0,r||(a=serializeMessage(n),s=a.msg,i=a.binaryMsg),e.next=15,this._send(new GenericCommand({cmd:CommandType.patch,op:OpType.modify,patchMessage:new PatchCommand({patches:[new PatchItem({cid:this.id,mid:t.id,timestamp:Number(t.timestamp),recall:r,data:s,binaryMsg:i,mentionPids:n.mentionList,mentionAll:n.mentionedAll})],lastPatchTime:this._client._lastPatchTime})}));case 15:return o=t.id,u=t.cid,c=t.timestamp,p=t.from,d=t._status,_Object$assign(n,{id:o,cid:u,timestamp:c,from:p,_status:d}),this.lastMessage.id===n.id&&(this.lastMessage=n),e.abrupt("return",n);case 19:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)}),t.prototype.count=(s=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("count"),e.next=3,this._send(new GenericCommand({op:"count"}));case 3:return t=e.sent,e.abrupt("return",t.convMessage.count);case 5:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)}),t.prototype._addMembers=function(){},t.prototype._removeMembers=function(){},t.prototype.update=(i=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,n){return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n instanceof Message){e.next=2;break}throw new TypeError(n+" is not a Message");case 2:return e.abrupt("return",this._update(t,n,!1));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)}),t.prototype.recall=(a=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._update(t,new RecalledMessage,!0));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)}),t.prototype.queryMessages=(o=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t,n,r,s,i,a,o,u,c,p,d,m,l,h,_,f=this,g=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._debug("query messages %O",g),t=g.beforeTime,n=g.beforeMessageId,r=g.afterTime,s=g.afterMessageId,i=g.limit,a=g.direction,o=g.type,u=g.startTime,c=g.startMessageId,p=g.startClosed,d=g.endTime,m=g.endMessageId,l=g.endClosed,!(n||t||s||r)){e.next=5;break}return console.warn("DEPRECATION: queryMessages options beforeTime, beforeMessageId, afterTime and afterMessageId are deprecated in favor of startTime, startMessageId, endTime and endMessageId."),e.abrupt("return",this.queryMessages({startTime:t,startMessageId:n,endTime:r,endMessageId:s,limit:i}));case 5:if(!c||u){e.next=7;break}throw new Error("query option startMessageId must be used with option startTime");case 7:if(!m||d){e.next=9;break}throw new Error("query option endMessageId must be used with option endTime");case 9:return(h={t:u,mid:c,tIncluded:p,tt:d,tmid:m,ttIncluded:l,l:i,lctype:o}).t instanceof Date&&(h.t=h.t.getTime()),h.tt instanceof Date&&(h.tt=h.tt.getTime()),void 0!==a?h.direction=a:h.tt>h.t&&(h.direction=MessageQueryDirection.OLD_TO_NEW),e.next=15,this._send(new GenericCommand({cmd:"logs",logsMessage:new LogsCommand(_Object$assign(h,{cid:this.id}))}));case 15:return _=e.sent,e.abrupt("return",_Promise.all(_.logsMessage.logs.map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s,i=t.msgId,a=t.timestamp,o=t.patchTimestamp,u=t.from,c=t.ackAt,p=t.readAt,d=t.data,m=t.mentionAll,l=t.mentionPids,h=t.bin;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={data:d,bin:h,id:i,cid:f.id,timestamp:a,from:u,deliveredAt:c,updatedAt:o,mentionList:l,mentionedAll:m},e.next=3,f._client.parseMessage(n);case 3:return r=e.sent,s=MessageStatus.SENT,2===f.members.length&&(c&&(s=MessageStatus.DELIVERED),c&&f._setLastDeliveredAt(c),p&&f._setLastReadAt(p)),r._setStatus(s),e.abrupt("return",r);case 8:case"end":return e.stop()}}),e,f)})));return function(t){return e.apply(this,arguments)}}())));case 17:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)}),t.prototype.createMessagesIterator=function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.beforeTime,r=t.beforeMessageId,s=t.limit,i=void 0;return{next:function(){return(i=void 0===i?e.queryMessages({limit:s,startTime:n,startMessageId:r}):i.then((function(t){return 0===t.length||t.length<s?[]:e.queryMessages({startTime:t[0].timestamp,startMessageId:t[0].id,limit:s})}))).then((function(e){return{value:_Array$from(e),done:0===e.length||e.length<s}}))}}},t.prototype.read=(u=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.unreadMessagesCount=0,this._setUnreadMessagesMentioned(!1),!this.transient){e.next=4;break}return e.abrupt("return",this);case 4:return t=this._client,internal(t).readConversationsBuffer||(internal(t).readConversationsBuffer=new _Set),internal(t).readConversationsBuffer.add(this),t._doSendRead(),e.abrupt("return",this);case 9:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)}),t.prototype._handleReceipt=function(e){var t=e.messageId,n=e.timestamp;e.read?this._setLastReadAt(n):this._setLastDeliveredAt(n);var r=internal(this).messagesWaitingForReceipt,s=r[t];s&&(s._setStatus(MessageStatus.DELIVERED),s.deliveredAt=n,delete r[t])},t.prototype.fetchReceiptTimestamps=(c=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t,n,r,s;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._send(new GenericCommand({op:"max_read"}));case 2:return t=e.sent,n=t.convMessage,r=n.maxReadTimestamp,s=n.maxAckTimestamp,this._setLastDeliveredAt(s),this._setLastReadAt(r),e.abrupt("return",this);case 9:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)}),t.prototype._fetchAllReceiptTimestamps=function(){var e=new ConvCommand({queryAllMembers:!0});return this._send(new GenericCommand({op:"max_read",convMessage:e})).then((function(e){return e.convMessage.maxReadTuples.filter((function(e){return e.maxAckTimestamp||e.maxReadTimestamp})).map((function(e){var t=e.pid,n=e.maxAckTimestamp,r=e.maxReadTimestamp;return{pid:t,lastDeliveredAt:decodeDate(n),lastReadAt:decodeDate(r)}}))}))},_createClass(t,[{key:"unreadMessagesMentioned",get:function(){return internal(this).unreadMessagesMentioned}},{key:"unreadMessagesCount",set:function(e){e!==this.unreadMessagesCount&&(internal(this).unreadMessagesCount=e,this._client.emit(UNREAD_MESSAGES_COUNT_UPDATE,[this]))},get:function(){return internal(this).unreadMessagesCount}},{key:"lastMessageAt",set:function(e){var t=decodeDate(e);t<=this._lastMessageAt||(this._lastMessageAt=t)},get:function(){return this._lastMessageAt}},{key:"lastDeliveredAt",get:function(){return 2!==this.members.length?null:internal(this).lastDeliveredAt}},{key:"lastReadAt",get:function(){return 2!==this.members.length?null:internal(this).lastReadAt}}]),t}(EventEmitter),debug$6=d("LC:SignatureFactoryRunner");function _validateSignature(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.signature,n=e.timestamp,r=e.nonce;if("string"!=typeof t||"number"!=typeof n||"string"!=typeof r)throw new Error("malformed signature");return{signature:t,timestamp:n,nonce:r}}var runSignatureFactory=function(e,t){return _Promise.resolve().then((function(){return debug$6("call signatureFactory with %O",t),e.apply(void 0,_toConsumableArray(t))})).then(tap((function(e){return debug$6("sign result %O",e)})),(function(e){throw e.message="sign error: "+e.message,debug$6(e),e})).then(_validateSignature)},createPartiallySuccess=function(e){return{successfulClientIds:e.allowedPids,failures:e.failedPids.map((function(e){var t=e.pids,n=_objectWithoutProperties(e,["pids"]);return _Object$assign(createError(n),{clientIds:t})}))}},PersistentConversation=function(e){function t(n,r,s){var i=r.creator,a=r.createdAt,o=r.updatedAt,u=r.transient,c=void 0!==u&&u,p=r.system,d=void 0!==p&&p,m=r.muted,l=void 0!==m&&m,h=r.mutedMembers,_=void 0===h?[]:h,f=_objectWithoutProperties(r,["creator","createdAt","updatedAt","transient","system","muted","mutedMembers"]);_classCallCheck(this,t);var g=_possibleConstructorReturn(this,e.call(this,_extends({},n,{creator:i,createdAt:a,updatedAt:o,mutedMembers:_,transient:c,system:d,muted:l,_attributes:f}),s));return g._reset(),g}var n,r,s,i,a,o,u,c,p,d,m,l,h,_,f,g;return _inherits(t,e),t.prototype.get=function(e){return internal(this).currentAttributes[e]},t.prototype.set=function(e,t){this._debug("set ["+e+"]: "+t);var n=internal(this).pendingAttributes,r=_Object$keys(n),s=new RegExp("^"+e),i=r.filter(s.test.bind(s));if(i.forEach((function(e){delete n[e]})),i.length)n[e]=t;else{var a=_Array$find(r,(function(t){return 0===e.indexOf(t)}));a?setValue(n[a],e.slice(a.length+1),t):n[e]=t}return this._buildCurrentAttributes(),this},t.prototype._buildCurrentAttributes=function(){var e=internal(this).pendingAttributes;internal(this).currentAttributes=_Object$keys(e).reduce((function(t,n){return setValue(t,n,e[n])}),cloneDeep(this._attributes))},t.prototype._updateServerAttributes=function(e){var t=this;_Object$keys(e).forEach((function(n){return setValue(t._attributes,n,e[n])})),this._buildCurrentAttributes()},t.prototype._reset=function(){_Object$assign(internal(this),{pendingAttributes:{},currentAttributes:this._attributes})},t.prototype.save=(n=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t,n,r;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._debug("save"),t=internal(this).pendingAttributes,!isEmpty(t)){e.next=5;break}return this._debug("nothing touched, resolve with self"),e.abrupt("return",this);case 5:return this._debug("attr: %O",t),n=new ConvCommand({attr:new JsonObjectMessage({data:_JSON$stringify(encode(t))})}),e.next=9,this._send(new GenericCommand({op:"update",convMessage:n}));case 9:return r=e.sent,this.updatedAt=r.convMessage.udate,this._attributes=internal(this).currentAttributes,internal(this).pendingAttributes={},e.abrupt("return",this);case 14:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)}),t.prototype.fetch=(r=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._client.getQuery().equalTo("objectId",this.id),e.next=3,t.find();case 3:return e.abrupt("return",this);case 4:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)}),t.prototype.mute=(s=_asyncToGenerator(_regeneratorRuntime.mark((function e(){return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("mute"),e.next=3,this._send(new GenericCommand({op:"mute"}));case 3:return this.transient||(this.muted=!0,this.mutedMembers=union(this.mutedMembers,[this._client.id])),e.abrupt("return",this);case 5:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)}),t.prototype.unmute=(i=_asyncToGenerator(_regeneratorRuntime.mark((function e(){return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("unmute"),e.next=3,this._send(new GenericCommand({op:"unmute"}));case 3:return this.transient||(this.muted=!1,this.mutedMembers=difference(this.mutedMembers,[this._client.id])),e.abrupt("return",this);case 5:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)}),t.prototype._appendConversationSignature=(a=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,n,r){var s,i;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._client.options.conversationSignatureFactory){e.next=6;break}return s=[this.id,this._client.id,r.sort(),n],e.next=4,runSignatureFactory(this._client.options.conversationSignatureFactory,s);case 4:i=e.sent,_Object$assign(t.convMessage,keyRemap({signature:"s",timestamp:"t",nonce:"n"},i));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return a.apply(this,arguments)}),t.prototype._appendBlacklistSignature=(o=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,n,r){var s,i;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._client.options.blacklistSignatureFactory){e.next=6;break}return s=[this._client.id,this.id,r.sort(),n],e.next=4,runSignatureFactory(this._client.options.blacklistSignatureFactory,s);case 4:i=e.sent,_Object$assign(t.blacklistMessage,keyRemap({signature:"s",timestamp:"t",nonce:"n"},i));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return o.apply(this,arguments)}),t.prototype.add=(u=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s,i;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("add",t),"string"==typeof t&&(t=[t]),n=new GenericCommand({op:"add",convMessage:new ConvCommand({m:t})}),e.next=5,this._appendConversationSignature(n,"add",t);case 5:return e.next=7,this._send(n);case 7:return r=e.sent,s=r.convMessage,i=r.convMessage.allowedPids,this._addMembers(i),e.abrupt("return",createPartiallySuccess(s));case 12:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)}),t.prototype.remove=(c=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s,i;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("remove",t),"string"==typeof t&&(t=[t]),n=new GenericCommand({op:"remove",convMessage:new ConvCommand({m:t})}),e.next=5,this._appendConversationSignature(n,"remove",t);case 5:return e.next=7,this._send(n);case 7:return r=e.sent,s=r.convMessage,i=r.convMessage.allowedPids,this._removeMembers(i),e.abrupt("return",createPartiallySuccess(s));case 12:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)}),t.prototype.join=(p=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t=this;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("join"),e.abrupt("return",this.add(this._client.id).then((function(e){var n=e.failures;if(n[0])throw n[0];return t})));case 2:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)}),t.prototype.quit=(d=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t=this;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("quit"),e.abrupt("return",this.remove(this._client.id).then((function(e){var n=e.failures;if(n[0])throw n[0];return t})));case 2:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)}),t.prototype.muteMembers=(m=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("mute",t),t=ensureArray(t),n=new GenericCommand({op:OpType.add_shutup,convMessage:new ConvCommand({m:t})}),e.next=5,this._send(n);case 5:return r=e.sent,s=r.convMessage,e.abrupt("return",createPartiallySuccess(s));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)}),t.prototype.unmuteMembers=(l=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("unmute",t),t=ensureArray(t),n=new GenericCommand({op:OpType.remove_shutup,convMessage:new ConvCommand({m:t})}),e.next=5,this._send(n);case 5:return r=e.sent,s=r.convMessage,e.abrupt("return",createPartiallySuccess(s));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)}),t.prototype.queryMutedMembers=(h=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t,n,r,s,i,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=a.limit,u=a.next;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("query muted: limit %O, next: %O",o,u),t=new GenericCommand({op:OpType.query_shutup,convMessage:new ConvCommand({limit:o,next:u})}),e.next=4,this._send(t);case 4:return n=e.sent,r=n.convMessage,s=r.m,i=r.next,e.abrupt("return",{results:s,next:i});case 9:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)}),t.prototype.blockMembers=(_=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("block",t),t=ensureArray(t),n=new GenericCommand({cmd:"blacklist",op:OpType.block,blacklistMessage:new BlacklistCommand({srcCid:this.id,toPids:t})}),e.next=5,this._appendBlacklistSignature(n,"conversation-block-clients",t);case 5:return e.next=7,this._send(n);case 7:return r=e.sent,s=r.blacklistMessage,e.abrupt("return",createPartiallySuccess(s));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)}),t.prototype.unblockMembers=(f=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("unblock",t),t=ensureArray(t),n=new GenericCommand({cmd:"blacklist",op:OpType.unblock,blacklistMessage:new BlacklistCommand({srcCid:this.id,toPids:t})}),e.next=5,this._appendBlacklistSignature(n,"conversation-unblock-clients",t);case 5:return e.next=7,this._send(n);case 7:return r=e.sent,s=r.blacklistMessage,e.abrupt("return",createPartiallySuccess(s));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)}),t.prototype.queryBlockedMembers=(g=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t,n,r,s,i,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=a.limit,u=a.next;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("query blocked: limit %O, next: %O",o,u),t=new GenericCommand({cmd:"blacklist",op:OpType.query,blacklistMessage:new BlacklistCommand({srcCid:this.id,limit:o,next:u})}),e.next=4,this._send(t);case 4:return n=e.sent,r=n.blacklistMessage,s=r.blockedPids,i=r.next,e.abrupt("return",{results:s,next:i});case 9:case"end":return e.stop()}}),e,this)}))),function(){return g.apply(this,arguments)}),t.prototype.toFullJSON=function(){var t=this.creator,n=this.system,r=this.transient,s=this.createdAt,i=this.updatedAt,a=this._attributes;return _extends({},e.prototype.toFullJSON.call(this),{creator:t,system:n,transient:r,createdAt:getTime(s),updatedAt:getTime(i)},a)},t.prototype.toJSON=function(){var t=this.creator,n=this.system,r=this.transient,s=this.muted,i=this.mutedMembers,a=this.createdAt,o=this.updatedAt,u=this._attributes;return _extends({},e.prototype.toJSON.call(this),{creator:t,system:n,transient:r,muted:s,mutedMembers:i,createdAt:a,updatedAt:o},u)},_createClass(t,[{key:"createdAt",set:function(e){this._createdAt=decodeDate(e)},get:function(){return this._createdAt}},{key:"updatedAt",set:function(e){this._updatedAt=decodeDate(e)},get:function(){return this._updatedAt}},{key:"name",get:function(){return this.get("name")},set:function(e){this.set("name",e)}}]),t}(ConversationBase),ConversationMemberRole={OWNER:"Owner",MANAGER:"Manager",MEMBER:"Member"};_Object$freeze(ConversationMemberRole);var _dec$2,_dec2,_class$3,ConversationMemberInfo=function(){function e(t){var n=t.conversation,r=t.memberId,s=t.role;if(_classCallCheck(this,e),!n)throw new Error("conversation requried");if(!r)throw new Error("memberId requried");_Object$assign(internal(this),{conversation:n,memberId:r,role:s})}return e.prototype.toJSON=function(){return{conversationId:this.conversationId,memberId:this.memberId,role:this.role,isOwner:this.isOwner}},_createClass(e,[{key:"conversationId",get:function(){return internal(this).conversation.id}},{key:"memberId",get:function(){return internal(this).memberId}},{key:"role",get:function(){return this.isOwner?ConversationMemberRole.OWNER:internal(this).role}},{key:"isOwner",get:function(){return this.memberId===internal(this).conversation.creator}}]),e}(),Conversation=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,e.apply(this,arguments))}var n,r,s,i;return _inherits(t,e),t.prototype._addMembers=function(t){var n=this;e.prototype._addMembers.call(this,t),this.members=union(this.members,t);var r=internal(this).memberInfoMap;r&&t.forEach((function(e){r[e]=r[e]||new ConversationMemberInfo({conversation:n,memberId:e,role:ConversationMemberRole.MEMBER})}))},t.prototype._removeMembers=function(t){e.prototype._removeMembers.call(this,t),this.members=difference(this.members,t);var n=internal(this).memberInfoMap;n&&t.forEach((function(e){delete n[e]}))},t.prototype._fetchAllMemberInfo=(n=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t,n,r,s=this;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._client._requestWithSessionToken({method:"GET",path:"/classes/_ConversationMemberInfo",query:{where:{cid:this.id}}});case 2:return t=e.sent,n=t.results.map((function(e){return new ConversationMemberInfo({conversation:s,memberId:e.clientId,role:e.role})})),r={},n.forEach((function(e){r[e.memberId]=e})),this.members.forEach((function(e){r[e]=r[e]||new ConversationMemberInfo({conversation:s,memberId:e,role:ConversationMemberRole.MEMBER})})),internal(this).memberInfoMap=r,e.abrupt("return",r);case 9:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)}),t.prototype.getAllMemberInfo=(r=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t,n,r=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).noCache,s=void 0!==r&&r;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=internal(this),(n=t.memberInfoMap)&&!s){e.next=5;break}return e.next=4,this._fetchAllMemberInfo();case 4:n=e.sent;case 5:return e.abrupt("return",this.members.map((function(e){return n[e]})));case 6:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)}),t.prototype.getMemberInfo=(s=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(-1!==this.members.indexOf(t)){e.next=2;break}throw new Error(t+" is not the mumber of conversation["+this.id+"]");case 2:if(n=internal(this),(r=n.memberInfoMap)&&r[t]){e.next=6;break}return e.next=6,this.getAllMemberInfo();case 6:return e.abrupt("return",internal(this).memberInfoMap[t]);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)}),t.prototype.updateMemberRole=(i=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,n){var r,s;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._debug("update member role"),n!==ConversationMemberRole.OWNER){e.next=3;break}throw createError({code:ErrorCode.OWNER_PROMOTION_NOT_ALLOWED});case 3:return e.next=5,this._send(new GenericCommand({op:OpType.member_info_update,convMessage:new ConvCommand({targetClientId:t,info:new ConvMemberInfo({pid:t,role:n})})}));case 5:return r=internal(this),(s=r.memberInfos)&&s[t]&&(internal(s[t]).role=n),e.abrupt("return",this);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)}),t}(PersistentConversation),ChatRoom=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,e.apply(this,arguments))}return _inherits(t,e),t}(PersistentConversation),ServiceConversation=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,e.apply(this,arguments))}var n,r;return _inherits(t,e),t.prototype.subscribe=(n=_asyncToGenerator(_regeneratorRuntime.mark((function e(){return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.join());case 1:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)}),t.prototype.unsubscribe=(r=_asyncToGenerator(_regeneratorRuntime.mark((function e(){return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.quit());case 1:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)}),t}(PersistentConversation),transformNotFoundError=function(e){return e.code===ErrorCode.CONVERSATION_NOT_FOUND?createError({code:ErrorCode.TEMPORARY_CONVERSATION_EXPIRED}):e},TemporaryConversation=function(e){function t(n,r,s){var i=r.expiredAt;return _classCallCheck(this,t),_possibleConstructorReturn(this,e.call(this,_extends({},n,{expiredAt:i}),s))}var n,r;return _inherits(t,e),t.prototype._send=(n=_asyncToGenerator(_regeneratorRuntime.mark((function t(){var n,r,s,i,a=arguments;return _regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.expired){t.next=2;break}throw createError({code:ErrorCode.TEMPORARY_CONVERSATION_EXPIRED});case 2:for(t.prev=2,r=a.length,s=Array(r),i=0;i<r;i++)s[i]=a[i];return t.next=6,(n=e.prototype._send).call.apply(n,[this].concat(_toConsumableArray(s)));case 6:return t.abrupt("return",t.sent);case 9:throw t.prev=9,t.t0=t.catch(2),transformNotFoundError(t.t0);case 12:case"end":return t.stop()}}),t,this,[[2,9]])}))),function(){return n.apply(this,arguments)}),t.prototype.send=(r=_asyncToGenerator(_regeneratorRuntime.mark((function t(){var n,r,s,i,a=arguments;return _regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:for(t.prev=0,r=a.length,s=Array(r),i=0;i<r;i++)s[i]=a[i];return t.next=4,(n=e.prototype.send).call.apply(n,[this].concat(_toConsumableArray(s)));case 4:return t.abrupt("return",t.sent);case 7:throw t.prev=7,t.t0=t.catch(0),transformNotFoundError(t.t0);case 10:case"end":return t.stop()}}),t,this,[[0,7]])}))),function(){return r.apply(this,arguments)}),t.prototype.toFullJSON=function(){var t=this.expiredAt;return _extends({},e.prototype.toFullJSON.call(this),{expiredAt:getTime(t)})},t.prototype.toJSON=function(){var t=this.expiredAt,n=this.expired;return _extends({},e.prototype.toJSON.call(this),{expiredAt:t,expired:n})},_createClass(t,[{key:"expiredAt",set:function(e){this._expiredAt=decodeDate(e)},get:function(){return this._expiredAt}},{key:"expired",get:function(){return this.expiredAt<new Date}}]),t}(ConversationBase),debug$7=d("LC:ConversationQuery"),ConversationQuery=function(){function e(t){_classCallCheck(this,e),this._client=t,this._where={},this._extraOptions={}}var t;return e._encode=function(e){return e instanceof Date?{__type:"Date",iso:e.toJSON()}:e instanceof RegExp?e.source:e},e._quote=function(e){return"\\Q"+e.replace("\\E","\\E\\\\E\\Q")+"\\E"},e._calculateFlag=function(e){return["withLastMessagesRefreshed","compact"].reduce((function(t,n){return(t<<1)+Boolean(e[n])}),0)},e.prototype._addCondition=function(e,t,n){return this._where[e]||(this._where[e]={}),this._where[e][t]=this.constructor._encode(n),this},e.prototype.toJSON=function(){var e={where:this._where,flag:this.constructor._calculateFlag(this._extraOptions)};return void 0!==this._skip&&(e.skip=this._skip),void 0!==this._limit&&(e.limit=this._limit),void 0!==this._order&&(e.sort=this._order),debug$7(e),e},e.prototype.containsMembers=function(e){return this.containsAll("m",e)},e.prototype.withMembers=function(e,t){var n=new _Set(e);return t&&n.add(this._client.id),this.sizeEqualTo("m",n.size),this.containsMembers(_Array$from(n))},e.prototype.equalTo=function(e,t){return this._where[e]=this.constructor._encode(t),this},e.prototype.lessThan=function(e,t){return this._addCondition(e,"$lt",t)},e.prototype.lessThanOrEqualTo=function(e,t){return this._addCondition(e,"$lte",t)},e.prototype.greaterThan=function(e,t){return this._addCondition(e,"$gt",t)},e.prototype.greaterThanOrEqualTo=function(e,t){return this._addCondition(e,"$gte",t)},e.prototype.notEqualTo=function(e,t){return this._addCondition(e,"$ne",t)},e.prototype.exists=function(e){return this._addCondition(e,"$exists",!0)},e.prototype.doesNotExist=function(e){return this._addCondition(e,"$exists",!1)},e.prototype.containedIn=function(e,t){return this._addCondition(e,"$in",t)},e.prototype.notContainsIn=function(e,t){return this._addCondition(e,"$nin",t)},e.prototype.containsAll=function(e,t){return this._addCondition(e,"$all",t)},e.prototype.contains=function(t,n){return this._addCondition(t,"$regex",e._quote(n))},e.prototype.startsWith=function(t,n){return this._addCondition(t,"$regex","^"+e._quote(n))},e.prototype.endsWith=function(t,n){return this._addCondition(t,"$regex",e._quote(n)+"$")},e.prototype.matches=function(e,t){this._addCondition(e,"$regex",t);var n="";return t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),n&&n.length&&this._addCondition(e,"$options",n),this},e.prototype.sizeEqualTo=function(e,t){return this._addCondition(e,"$size",t)},e.prototype.limit=function(e){return this._limit=e,this},e.prototype.skip=function(e){return this._skip=e,this},e.prototype.ascending=function(e){return this._order=e,this},e.prototype.addAscending=function(e){return this._order?this._order+=","+e:this._order=e,this},e.prototype.descending=function(e){return this._order="-"+e,this},e.prototype.addDescending=function(e){return this._order?this._order+=",-"+e:this._order="-"+e,this},e.prototype.withLastMessagesRefreshed=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._extraOptions.withLastMessagesRefreshed=e,this},e.prototype.compact=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._extraOptions.compact=e,this},e.prototype.find=(t=_asyncToGenerator(_regeneratorRuntime.mark((function e(){return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._client._executeQuery(this));case 1:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)}),e}(),debug$8=d("LC:SessionManager"),SessionManager=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.refresh,r=t.onBeforeGetSessionToken;_classCallCheck(this,e),this.refresh=n,this._onBeforeGetSessionToken=r,this.setSessionToken(null,0)}var t,n;return e.prototype.setSessionToken=function(e,t){debug$8("set session token",e,t);var n=new Expirable(e,1e3*t);return this._sessionToken=n,delete this._pendingSessionTokenPromise,n},e.prototype.setSessionTokenAsync=(t=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r=this;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._sessionToken,this._pendingSessionTokenPromise=t.catch((function(e){throw r._sessionToken=n,e})),e.t0=this.setSessionToken,e.t1=this,e.t2=_toConsumableArray,e.next=7,this._pendingSessionTokenPromise;case 7:return e.t3=e.sent,e.t4=(0,e.t2)(e.t3),e.abrupt("return",e.t0.apply.call(e.t0,e.t1,e.t4));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)}),e.prototype.getSessionToken=(n=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t,n,r,s,i,a=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).autoRefresh,o=void 0===a||a;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(debug$8("get session token"),this._onBeforeGetSessionToken&&this._onBeforeGetSessionToken(this),e.t0=this._sessionToken,e.t0){e.next=7;break}return e.next=6,this._pendingSessionTokenPromise;case 6:e.t0=e.sent;case 7:if(t=e.t0,n=t.value,r=t.originalValue,n!==Expirable.EXPIRED||!o||!this.refresh){e.next=18;break}return debug$8("refresh expired session token"),e.next=14,this.setSessionTokenAsync(this.refresh(this,r));case 14:return s=e.sent,i=s.value,debug$8("session token",i),e.abrupt("return",i);case 18:return debug$8("session token",n),e.abrupt("return",n);case 20:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)}),e.prototype.revoke=function(){this._sessionToken&&(this._sessionToken.expiredAt=-1)},e}();function _applyDecoratedDescriptor$1(e,t,n,r,s){var i={};return Object.keys(r).forEach((function(e){i[e]=r[e]})),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=n.slice().reverse().reduce((function(n,r){return r(e,t,n)||n}),i),s&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(s):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(e,t,i),i=null),i}var _class$4,_dec$3,_class$5,_class$6,debug$9=d("LC:IMClient"),INVITED$1=INVITED,KICKED$1=KICKED,MEMBERS_JOINED$1=MEMBERS_JOINED,MEMBERS_LEFT$1=MEMBERS_LEFT,MEMBER_INFO_UPDATED$1=MEMBER_INFO_UPDATED,BLOCKED$1=BLOCKED,UNBLOCKED$1=UNBLOCKED,MEMBERS_BLOCKED$1=MEMBERS_BLOCKED,MEMBERS_UNBLOCKED$1=MEMBERS_UNBLOCKED,MUTED$1=MUTED,UNMUTED$1=UNMUTED,MEMBERS_MUTED$1=MEMBERS_MUTED,MEMBERS_UNMUTED$1=MEMBERS_UNMUTED,MESSAGE$2=MESSAGE$1,UNREAD_MESSAGES_COUNT_UPDATE$1=UNREAD_MESSAGES_COUNT_UPDATE,CLOSE$1=CLOSE,CONFLICT$1=CONFLICT,UNHANDLED_MESSAGE$1=UNHANDLED_MESSAGE,CONVERSATION_INFO_UPDATED$1=CONVERSATION_INFO_UPDATED,MESSAGE_RECALL$1=MESSAGE_RECALL,MESSAGE_UPDATE$1=MESSAGE_UPDATE,INFO_UPDATED$1=INFO_UPDATED,isTemporaryConversatrionId=function(e){return/^_tmp:/.test(e)},configBitmap=59,IMClient=(_dec$2=throttle(1e3),_dec2=throttle(1e3),_class$3=function(e){function t(n){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments[2];if(_classCallCheck(this,t),void 0!==n&&"string"!=typeof n)throw new TypeError("Client id ["+n+"] is not a String");var i=_possibleConstructorReturn(this,e.call(this));if(_Object$assign(i,{id:n,options:r},s),!i._messageParser)throw new Error("IMClient must be initialized with a MessageParser");return i._conversationCache=new Cache("client:"+i.id),i._ackMessageBuffer={},internal(i).lastPatchTime=Date.now(),internal(i).lastNotificationTime=void 0,internal(i)._eventemitter=new EventEmitter,debug$9.enabled&&_Object$values(Event).forEach((function(e){return i.on(e,(function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];return i._debug(e+" event emitted. %o",n)}))})),applyDecorators(i._plugins.onIMClientCreate,i),i}var n,r,s,i,a,o,u,c,p,d,m,l,h,_,f,g,y,b,v,E,C;return _inherits(t,e),t.prototype._debug=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];debug$9.apply(void 0,t.concat(["["+this.id+"]"]))},t.prototype._dispatchCommand=(n=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._debug(trim(t),"received"),t.serverTs&&(internal(this).lastNotificationTime=getTime(decodeDate(t.serverTs))),e.t0=t.cmd,e.next=e.t0===CommandType.conv?5:e.t0===CommandType.direct?6:e.t0===CommandType.session?7:e.t0===CommandType.unread?8:e.t0===CommandType.rcp?9:e.t0===CommandType.patch?10:11;break;case 5:return e.abrupt("return",this._dispatchConvMessage(t));case 6:return e.abrupt("return",this._dispatchDirectMessage(t));case 7:return e.abrupt("return",this._dispatchSessionMessage(t));case 8:return e.abrupt("return",this._dispatchUnreadMessage(t));case 9:return e.abrupt("return",this._dispatchRcpMessage(t));case 10:return e.abrupt("return",this._dispatchPatchMessage(t));case 11:return e.abrupt("return",this.emit(UNHANDLED_MESSAGE$1,t));case 12:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)}),t.prototype._dispatchSessionMessage=(r=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.sessionMessage,r=n.code,s=n.reason,e.t0=t.op,e.next=e.t0===OpType.closed?4:8;break;case 4:if(internal(this)._eventemitter.emit("close"),r!==ErrorCode.SESSION_CONFLICT){e.next=7;break}return e.abrupt("return",this.emit(CONFLICT$1,{reason:s}));case 7:return e.abrupt("return",this.emit(CLOSE$1,{code:r,reason:s}));case 8:throw this.emit(UNHANDLED_MESSAGE$1,t),new Error("Unrecognized session command");case 10:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)}),t.prototype._dispatchUnreadMessage=function(e){var t=this,n=e.unreadMessage,r=n.convs,s=n.notifTime;return internal(this).lastUnreadNotifTime=s,this.getConversations(r.map((function(e){return e.cid}))).then((function(){return _Promise.all(r.map((function(e){var n=e.cid,r=e.unread,s=e.mid,i=e.timestamp,a=e.from,o=e.data,u=e.binaryMsg,c=e.patchTimestamp,p=e.mentioned,d=t._conversationCache.get(n);if(!d)return null;var m=void 0;return i&&(m=decodeDate(i),d.lastMessageAt=m),(s?t._messageParser.parse(u||o).then((function(e){_Object$assign(e,{id:s,cid:n,timestamp:m,updatedAt:c,from:a}),d.lastMessage=e})):_Promise.resolve()).then((function(){return d._setUnreadMessagesMentioned(p),r===internal(d).unreadMessagesCount?null:(internal(d).unreadMessagesCount=r,d)}))}))).then((function(e){return e.filter((function(e){return e}))}))})).then((function(e){e.length&&t.emit(UNREAD_MESSAGES_COUNT_UPDATE$1,e)}))},t.prototype._dispatchRcpMessage=(s=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s,i,a,o;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.rcpMessage,r=t.rcpMessage.read,s=n.cid,i=n.id,a=decodeDate(n.t),o=this._conversationCache.get(s)){e.next=7;break}return e.abrupt("return");case 7:o._handleReceipt({messageId:i,timestamp:a,read:r});case 8:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)}),t.prototype._dispatchPatchMessage=function(e){var t=this,n=e.patchMessage.patches;return this.getConversations(n.map((function(e){return e.cid}))).then((function(){return _Promise.all(n.map((function(e){var n=e.cid,r=e.mid,s=e.timestamp,i=e.recall,a=e.data,o=e.patchTimestamp,u=e.from,c=e.binaryMsg,p=e.mentionAll,d=e.mentionPids,m=e.patchCode,l=e.patchReason,h=t._conversationCache.get(n);return h?t._messageParser.parse(c||a).then((function(e){var a=getTime(decodeDate(o));_Object$assign(e,{id:r,cid:n,timestamp:s,updatedAt:a,from:u,mentionList:d,mentionedAll:p}),e._setStatus(MessageStatus.SENT),e._updateMentioned(t.id),internal(t).lastPatchTime<a&&(internal(t).lastPatchTime=a),h.lastMessage&&h.lastMessage.id===r&&(h.lastMessage=e);var c=void 0;m&&(c={code:m.toNumber(),detail:l}),i?(t.emit(MESSAGE_RECALL$1,e,h,c),h.emit(MESSAGE_RECALL$1,e,c)):(t.emit(MESSAGE_UPDATE$1,e,h,c),h.emit(MESSAGE_UPDATE$1,e,c))})):null})))}))},t.prototype._dispatchConvMessage=(i=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s,i,a,o,u,c,p,d,m,l,h,_,f,g,y,b,v,E,C,M,T,R,A;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.convMessage,r=t.convMessage,s=r.initBy,i=r.m,a=r.info,o=r.attr,e.next=3,this.getConversation(n.cid);case 3:u=e.sent,e.t0=t.op,e.next=e.t0===OpType.joined?7:e.t0===OpType.left?12:e.t0===OpType.members_joined?17:e.t0===OpType.members_left?22:e.t0===OpType.members_blocked?27:e.t0===OpType.members_unblocked?31:e.t0===OpType.blocked?35:e.t0===OpType.unblocked?39:e.t0===OpType.members_shutuped?43:e.t0===OpType.members_unshutuped?47:e.t0===OpType.shutuped?51:e.t0===OpType.unshutuped?55:e.t0===OpType.member_info_changed?59:e.t0===OpType.updated?71:77;break;case 7:return u._addMembers([this.id]),c={invitedBy:s},this.emit(INVITED$1,c,u),u.emit(INVITED$1,c),e.abrupt("return");case 12:return u._removeMembers([this.id]),p={kickedBy:s},this.emit(KICKED$1,p,u),u.emit(KICKED$1,p),e.abrupt("return");case 17:return u._addMembers(i),d={invitedBy:s,members:i},this.emit(MEMBERS_JOINED$1,d,u),u.emit(MEMBERS_JOINED$1,d),e.abrupt("return");case 22:return u._removeMembers(i),m={kickedBy:s,members:i},this.emit(MEMBERS_LEFT$1,m,u),u.emit(MEMBERS_LEFT$1,m),e.abrupt("return");case 27:return l={blockedBy:s,members:i},this.emit(MEMBERS_BLOCKED$1,l,u),u.emit(MEMBERS_BLOCKED$1,l),e.abrupt("return");case 31:return h={unblockedBy:s,members:i},this.emit(MEMBERS_UNBLOCKED$1,h,u),u.emit(MEMBERS_UNBLOCKED$1,h),e.abrupt("return");case 35:return _={blockedBy:s},this.emit(BLOCKED$1,_,u),u.emit(BLOCKED$1,_),e.abrupt("return");case 39:return f={unblockedBy:s},this.emit(UNBLOCKED$1,f,u),u.emit(UNBLOCKED$1,f),e.abrupt("return");case 43:return g={mutedBy:s,members:i},this.emit(MEMBERS_MUTED$1,g,u),u.emit(MEMBERS_MUTED$1,g),e.abrupt("return");case 47:return y={unmutedBy:s,members:i},this.emit(MEMBERS_UNMUTED$1,y,u),u.emit(MEMBERS_UNMUTED$1,y),e.abrupt("return");case 51:return b={mutedBy:s},this.emit(MUTED$1,b,u),u.emit(MUTED$1,b),e.abrupt("return");case 55:return v={unmutedBy:s},this.emit(UNMUTED$1,v,u),u.emit(UNMUTED$1,v),e.abrupt("return");case 59:if(E=a.pid,C=a.role,internal(u).memberInfoMap||C){e.next=63;break}return e.abrupt("return");case 63:return e.next=65,u.getMemberInfo(E);case 65:return M=e.sent,internal(M).role=C,T={member:E,memberInfo:M,updatedBy:s},this.emit(MEMBER_INFO_UPDATED$1,T,u),u.emit(MEMBER_INFO_UPDATED$1,T),e.abrupt("return");case 71:return R=decode(JSON.parse(o.data)),u._updateServerAttributes(R),A={attributes:R,updatedBy:s},this.emit(CONVERSATION_INFO_UPDATED$1,A,u),u.emit(INFO_UPDATED$1,A),e.abrupt("return");case 77:throw this.emit(UNHANDLED_MESSAGE$1,t),new Error("Unrecognized conversation command");case 79:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)}),t.prototype._dispatchDirectMessage=function(e){var t=this,n=e.directMessage,r=e.directMessage,s=r.id,i=r.cid,a=r.fromPeerId,o=r.timestamp,u=r.transient,c=r.patchTimestamp,p=r.mentionPids,d=r.mentionAll,m=r.binaryMsg,l=r.msg,h=m?m.toArrayBuffer():l;return _Promise.all([this.getConversation(n.cid),this._messageParser.parse(h)]).then((function(e){var n=_slicedToArray(e,2),r=n[0],m=n[1];if(r)return _Object$assign(m,{id:s,cid:i,timestamp:o,updatedAt:c,from:a,mentionList:p,mentionedAll:d}),m._updateMentioned(t.id),m._setStatus(MessageStatus.SENT),m.from!==t.id&&(u||r.transient||t._sendAck(m)),t._dispatchParsedMessage(m,r)}))},t.prototype._dispatchParsedMessage=function(e,t){var n=this;return applyDispatcher(this._plugins.beforeMessageDispatch,[e,t]).then((function(r){!1!==r&&(t.lastMessage=e,t.lastMessageAt=e.timestamp,e.from!==n.id&&(t.unreadMessagesCount+=1,e.mentioned&&t._setUnreadMessagesMentioned(!0)),n.emit(MESSAGE$2,e,t),t.emit(MESSAGE$2,e))}))},t.prototype._sendAck=function(e){this._debug("send ack for %O",e);var t=e.cid;if(!t)throw new Error("missing cid");return this._ackMessageBuffer[t]||(this._ackMessageBuffer[t]=[]),this._ackMessageBuffer[t].push(e),this._doSendAck()},t.prototype._doSendAck=function(){var e=this;this._connection.is("connected")&&(this._debug("do send ack %O",this._ackMessageBuffer),_Promise.all(_Object$keys(this._ackMessageBuffer).map((function(t){var n=e._ackMessageBuffer[t],r=n.map((function(e){return e.timestamp})),s=new GenericCommand({cmd:"ack",peerId:e.id,ackMessage:new AckCommand({cid:t,fromts:Math.min.apply(null,r),tots:Math.max.apply(null,r)})});return delete e._ackMessageBuffer[t],e._send(s,!1).catch((function(r){e._debug("send ack failed: %O",r),e._ackMessageBuffer[t]=n}))}))))},t.prototype._omitPeerId=function(e){internal(this).peerIdOmittable=e},t.prototype._send=function(e){var t,n=e;!internal(this).peerIdOmittable&&this.id&&(n.peerId=this.id);for(var r=arguments.length,s=Array(r>1?r-1:0),i=1;i<r;i++)s[i-1]=arguments[i];return(t=this._connection).send.apply(t,[n].concat(s))},t.prototype._open=(a=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,n,r){var s,i,a,o,u,c,p,d,m,l,h,_,f,g,y,b=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._debug("open session"),s=internal(this),i=s.lastUnreadNotifTime,a=s.lastPatchTime,o=new GenericCommand({cmd:"session",op:"open",appId:t,peerId:this.id,sessionMessage:new SessionCommand({ua:"js/"+version,r:b,lastUnreadNotifTime:i,lastPatchTime:a,configBitmap:configBitmap})}),b){e.next=12;break}if(_Object$assign(o.sessionMessage,trim({tag:n,deviceId:r})),!this.options.signatureFactory){e.next=10;break}return e.next=8,runSignatureFactory(this.options.signatureFactory,[this._identity]);case 8:u=e.sent,_Object$assign(o.sessionMessage,keyRemap({signature:"s",timestamp:"t",nonce:"n"},u));case 10:e.next=16;break;case 12:return e.next=14,this._sessionManager.getSessionToken({autoRefresh:!1});case 14:(c=e.sent)&&c!==Expirable.EXPIRED&&_Object$assign(o.sessionMessage,{st:c});case 16:return p=void 0,e.prev=17,e.next=20,this._send(o);case 20:p=e.sent,e.next=32;break;case 23:if(e.prev=23,e.t0=e.catch(17),e.t0.code!==ErrorCode.SESSION_TOKEN_EXPIRED){e.next=31;break}if(this._sessionManager){e.next=28;break}throw new Error("Unexpected session expiration");case 28:return debug$9("Session token expired, reopening"),this._sessionManager.revoke(),e.abrupt("return",this._open(t,n,r,b));case 31:throw e.t0;case 32:if(m=(d=p).peerId,l=d.sessionMessage,h=d.sessionMessage,_=h.st,f=h.stTtl,g=h.code,y=d.serverTs,!g){e.next=35;break}throw createError(l);case 35:return m?(this.id=m,this._identity||(this._identity=m),_&&(this._sessionManager=this._sessionManager||this._createSessionManager(),this._sessionManager.setSessionToken(_,f)),y&&(internal(this).lastPatchTime=getTime(decodeDate(y))),internal(this).lastNotificationTime?this._syncNotifications(internal(this).lastNotificationTime).catch((function(e){return console.warn("Syncing notifications failed:",e)})):internal(this).lastNotificationTime=Date.now()):console.warn("Unexpected session opened without peerId."),e.abrupt("return",void 0);case 37:case"end":return e.stop()}}),e,this,[[17,23]])}))),function(e,t,n){return a.apply(this,arguments)}),t.prototype._syncNotifications=(o=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s=this;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchNotifications(t);case 2:if(n=e.sent,r=n.hasMore,n.notifications.forEach((function(e){var t=e.cmd,n=e.op,r=e.serverTs,i=_objectWithoutProperties(e,["cmd","op","serverTs"]);s._dispatchCommand(_defineProperty({cmd:CommandType[t],op:OpType[n],serverTs:r},t+"Message",i))})),!r){e.next=8;break}return e.abrupt("return",this._syncNotifications(internal(this).lastNotificationTime));case 8:return e.abrupt("return",void 0);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)}),t.prototype._fetchNotifications=(u=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._requestWithSessionToken({method:"GET",path:"/rtm/notifications",query:{start_ts:t,notification_type:"permanent"}}));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)}),t.prototype._createSessionManager=function(){var e=this;return debug$9("create SessionManager"),new SessionManager({onBeforeGetSessionToken:this._connection.checkConnectionAvailability.bind(this._connection),refresh:function(t,n){return t.setSessionTokenAsync(_Promise.resolve(new GenericCommand({cmd:"session",op:"refresh",sessionMessage:new SessionCommand({ua:"js/"+version,st:n})})).then((r=_asyncToGenerator(_regeneratorRuntime.mark((function t(n){var r;return _regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.options.signatureFactory){t.next=5;break}return t.next=3,runSignatureFactory(e.options.signatureFactory,[e._identity]);case 3:r=t.sent,_Object$assign(n.sessionMessage,keyRemap({signature:"s",timestamp:"t",nonce:"n"},r));case 5:return t.abrupt("return",n);case 6:case"end":return t.stop()}}),t,e)}))),function(e){return r.apply(this,arguments)})).then(e._send.bind(e)).then((function(e){var t=e.sessionMessage;return[t.st,t.stTtl]})));var r}})},t.prototype._requestWithSessionToken=(c=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r=t.headers,s=t.query,i=_objectWithoutProperties(t,["headers","query"]);return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._sessionManager.getSessionToken();case 2:return n=e.sent,e.abrupt("return",this._request(_extends({headers:_extends({"X-LC-IM-Session-Token":n},r),query:_extends({client_id:this.id},s)},i)));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)}),t.prototype.close=(p=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t,n;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._debug("close session"),(t=internal(this)._eventemitter).emit("beforeclose"),!this._connection.is("connected")){e.next=7;break}return n=new GenericCommand({cmd:"session",op:"close"}),e.next=7,this._send(n);case 7:t.emit("close"),this.emit(CLOSE$1,{code:0});case 9:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)}),t.prototype.ping=(d=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._debug("ping"),t instanceof Array){e.next=3;break}throw new TypeError("clientIds "+t+" is not an Array");case 3:if(t.length){e.next=5;break}return e.abrupt("return",_Promise.resolve([]));case 5:return n=new GenericCommand({cmd:"session",op:"query",sessionMessage:new SessionCommand({sessionPeerIds:t})}),e.next=8,this._send(n);case 8:return r=e.sent,e.abrupt("return",r.sessionMessage.onlineSessionPeerIds);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)}),t.prototype.getConversation=(m=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"==typeof t){e.next=2;break}throw new TypeError(t+" is not a String");case 2:if(r){e.next=6;break}if(!(n=this._conversationCache.get(t))){e.next=6;break}return e.abrupt("return",n);case 6:if(!isTemporaryConversatrionId(t)){e.next=13;break}return e.next=9,this._getTemporaryConversations([t]);case 9:if(e.t0=e.sent[0],e.t0){e.next=12;break}e.t0=null;case 12:return e.abrupt("return",e.t0);case 13:return e.abrupt("return",this.getQuery().equalTo("objectId",t).find().then((function(e){return e[0]||null})));case 14:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)}),t.prototype.getConversations=(l=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s,i,a=this,o=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=o?t:t.filter((function(e){return null===a._conversationCache.get(e)}))).length){e.next=8;break}return r=remove(n,isTemporaryConversatrionId),s=[],n.length&&s.push(this.getQuery().containedIn("objectId",n).limit(999).find()),r.length&&(i=r.map(this._getTemporaryConversations.bind(this)),s.push.apply(s,_toConsumableArray(i))),e.next=8,_Promise.all(s);case 8:return e.abrupt("return",t.map((function(e){return a._conversationCache.get(e)})));case 9:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)}),t.prototype._getTemporaryConversations=(h=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new GenericCommand({cmd:"conv",op:"query",convMessage:new ConvCommand({tempConvIds:t})}),e.next=3,this._send(n);case 3:return r=e.sent,e.abrupt("return",this._handleQueryResults(r));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)}),t.prototype.getQuery=function(){return new ConversationQuery(this)},t.prototype.getChatRoomQuery=function(){return this.getQuery().equalTo("tr",!0)},t.prototype.getServiceConversationQuery=function(){return this.getQuery().equalTo("sys",!0)},t.prototype._executeQuery=(_=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.toJSON()).where=new JsonObjectMessage({data:_JSON$stringify(encode(n.where))}),r=new GenericCommand({cmd:"conv",op:"query",convMessage:new ConvCommand(n)}),e.next=5,this._send(r);case 5:return s=e.sent,e.abrupt("return",this._handleQueryResults(s));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)}),t.prototype._handleQueryResults=(f=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=void 0,e.prev=1,n=decode(JSON.parse(t.convMessage.results.data)),e.next=9;break;case 5:throw e.prev=5,e.t0=e.catch(1),r=_JSON$stringify(trim(t)),new Error("Parse query result failed: "+e.t0.message+". Command: "+r);case 9:return e.next=11,_Promise.all(n.map(this._parseConversationFromRawData.bind(this)));case 11:return n=e.sent,e.abrupt("return",n.map(this._upsertConversationToCache.bind(this)));case 13:case"end":return e.stop()}}),e,this,[[1,5]])}))),function(e){return f.apply(this,arguments)}),t.prototype._upsertConversationToCache=function(e){var t=this._conversationCache.get(e.id);return t?(this._debug("update cached conversation"),["creator","createdAt","updatedAt","lastMessageAt","lastMessage","mutedMembers","members","_attributes","transient","muted"].forEach((function(n){var r=e[n];void 0!==r&&(t[n]=r)})),t._reset&&t._reset()):(t=e,this._debug("no match, set cache"),this._conversationCache.set(e.id,e)),t},t.prototype.parseMessage=(g=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s=t.data,i=t.bin,a=void 0!==i&&i,o=_objectWithoutProperties(t,["data","bin"]);return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=a?base64Arraybuffer.decode(s):s,e.next=3,this._messageParser.parse(n);case 3:return r=e.sent,_Object$assign(r,o),r._updateMentioned(this.id),e.abrupt("return",r);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)}),t.prototype.parseConversation=(y=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r,s,i,a=t.id,o=t.lastMessageAt,u=t.lastMessage,c=t.lastDeliveredAt,p=t.lastReadAt,d=t.unreadMessagesCount,m=t.members,l=t.mentioned,h=_objectWithoutProperties(t,["id","lastMessageAt","lastMessage","lastDeliveredAt","lastReadAt","unreadMessagesCount","members","mentioned"]);return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n={id:a,lastMessageAt:o,lastMessage:u,lastDeliveredAt:c,lastReadAt:p,unreadMessagesCount:d,members:m,mentioned:l},!u){e.next=6;break}return e.next=4,this.parseMessage(u);case 4:n.lastMessage=e.sent,n.lastMessage._setStatus(MessageStatus.SENT);case 6:if(r=h.transient,s=h.system,i=h.expiredAt,!r){e.next=9;break}return e.abrupt("return",new ChatRoom(n,h,this));case 9:if(!s){e.next=11;break}return e.abrupt("return",new ServiceConversation(n,h,this));case 11:if(!i&&!isTemporaryConversatrionId(a)){e.next=13;break}return e.abrupt("return",new TemporaryConversation(n,{expiredAt:i},this));case 13:return e.abrupt("return",new Conversation(n,h,this));case 14:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)}),t.prototype._parseConversationFromRawData=(b=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n,r;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=keyRemap({objectId:"id",lm:"lastMessageAt",m:"members",tr:"transient",sys:"system",c:"creator",mu:"mutedMembers"},t)).msg&&(n.lastMessage={data:n.msg,bin:n.bin,from:n.msg_from,id:n.msg_mid,timestamp:n.msg_timestamp,updatedAt:n.patch_timestamp},delete n.lastMessageFrom,delete n.lastMessageId,delete n.lastMessageTimestamp,delete n.lastMessagePatchTimestamp),(r=n.ttl)&&(n.expiredAt=Date.now()+1e3*r),e.abrupt("return",this.parseConversation(n));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)}),t.prototype.createConversation=(v=_asyncToGenerator(_regeneratorRuntime.mark((function e(){var t,n,r,s,i,a,o,u,c,p,d,m,l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},h=l.members,_=l.name,f=l.transient,g=l.unique,y=l._tempConv,b=l._tempConvTTL,v=_objectWithoutProperties(l,["members","name","transient","unique","_tempConv","_tempConvTTL"]);return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(f||Array.isArray(h)){e.next=2;break}throw new TypeError("conversation members "+h+" is not an array");case 2:if((t=new _Set(h)).add(this.id),t=_Array$from(t).sort(),n=v||{},!_){e.next=10;break}if("string"==typeof _){e.next=9;break}throw new TypeError("conversation name "+_+" is not a string");case 9:n.name=_;case 10:if(n=new JsonObjectMessage({data:_JSON$stringify(encode(n))}),r=new GenericCommand({cmd:"conv",op:"start",convMessage:new ConvCommand({m:t,attr:n,transient:f,unique:g,tempConv:y,tempConvTTL:b})}),!this.options.conversationSignatureFactory){e.next=19;break}return s=[null,this._identity,t,"create"],e.next=17,runSignatureFactory(this.options.conversationSignatureFactory,s);case 17:i=e.sent,_Object$assign(r.convMessage,keyRemap({signature:"s",timestamp:"t",nonce:"n"},i));case 19:return e.next=21,this._send(r);case 21:return a=e.sent,o=a.convMessage,u=o.cid,c=o.cdate,p=o.tempConvTTL,d=_extends({name:_,transient:f,unique:g,id:u,createdAt:c,updatedAt:c,lastMessageAt:null,creator:this.id,members:f?[]:t},v),p&&(d.expiredAt=Date.now()+1e3*p),e.next=30,this.parseConversation(d);case 30:return m=e.sent,e.abrupt("return",this._upsertConversationToCache(m));case 32:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)}),t.prototype.createChatRoom=(E=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.createConversation(_extends({},t,{transient:!0,members:null,unique:!1,_tempConv:!1})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)}),t.prototype.createTemporaryConversation=(C=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var n=t.ttl,r=_objectWithoutProperties(t,["ttl"]);return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.createConversation(_extends({},r,{transient:!1,unique:!1,_tempConv:!0,_tempConvTTL:n})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)}),t.prototype._doSendRead=function(){var e=this;if(this._connection.is("connected")){var t=internal(this).readConversationsBuffer,n=_Array$from(t);if(n.length){var r=n.map((function(e){if(!(e instanceof ConversationBase))throw new TypeError(e+" is not a Conversation");return e.id}));this._debug("mark ["+r+"] as read"),t.clear(),this._sendReadCommand(n).catch((function(r){e._debug("send read failed: %O",r),n.forEach(t.add.bind(t))}))}}},t.prototype._sendReadCommand=function(e){var t=this;return this._send(new GenericCommand({cmd:"read",readMessage:new ReadCommand({convs:e.map((function(e){return new ReadTuple({cid:e.id,mid:e.lastMessage&&e.lastMessage.from!==t.id?e.lastMessage.id:void 0,timestamp:(e.lastMessageAt||new Date).getTime()})}))})}),!1)},t}(EventEmitter),_applyDecoratedDescriptor$1(_class$3.prototype,"_doSendAck",[_dec$2],_Object$getOwnPropertyDescriptor(_class$3.prototype,"_doSendAck"),_class$3.prototype),_applyDecoratedDescriptor$1(_class$3.prototype,"_doSendRead",[_dec2],_Object$getOwnPropertyDescriptor(_class$3.prototype,"_doSendRead"),_class$3.prototype),_class$3),RECONNECT_ERROR="reconnecterror",CoreEvent=Object.freeze({RECONNECT_ERROR:RECONNECT_ERROR,DISCONNECT:DISCONNECT,RECONNECT:RECONNECT,RETRY:RETRY,SCHEDULE:SCHEDULE,OFFLINE:OFFLINE,ONLINE:ONLINE}),BinaryMessage=IE10Compatible(_class$4=function(e){function t(n){if(_classCallCheck(this,t),!(n instanceof ArrayBuffer))throw new TypeError(n+" is not an ArrayBuffer");return _possibleConstructorReturn(this,e.call(this,n))}return _inherits(t,e),t.validate=function(e){return e instanceof ArrayBuffer},t.prototype.toJSON=function(){return _extends({},e.prototype._toJSON.call(this),{data:base64Arraybuffer.encode(this.content)})},t.prototype.toFullJSON=function(){return _extends({},e.prototype.toFullJSON.call(this),{bin:!0,data:base64Arraybuffer.encode(this.content)})},_createClass(t,[{key:"buffer",get:function(){return this.content},set:function(e){this.content=e}}]),t}(Message))||_class$4,TextMessage=(_dec$3=messageType(-1))(_class$5=IE10Compatible(_class$5=function(e){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(_classCallCheck(this,t),"string"!=typeof n)throw new TypeError(n+" is not a string");var r=_possibleConstructorReturn(this,e.call(this));return r.setText(n),r}return _inherits(t,e),t}(TypedMessage))||_class$5)||_class$5;function _applyDecoratedDescriptor$2(e,t,n,r,s){var i={};return Object.keys(r).forEach((function(e){i[e]=r[e]})),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=n.slice().reverse().reduce((function(n,r){return r(e,t,n)||n}),i),s&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(s):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(e,t,i),i=null),i}var debug$a=d("LC:MessageParser"),tryParseJson=function(e,t,n){var r=n.value;n.value=function(e){var t=void 0;if("string"!=typeof e)t=e;else try{t=JSON.parse(e)}catch(n){t=e}return r.call(this,t)}},applyPlugins=function(e,t,n){var r=n.value;n.value=function(e){var t=this;return _Promise.resolve(e).then(applyMiddlewares(this._plugins.beforeMessageParse)).then((function(e){return r.call(t,e)})).then(applyMiddlewares(this._plugins.afterMessageParse))}},MessageParser=(_class$6=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,e),this._plugins=t,this._messageClasses=[]}return e.prototype.register=function(e){if(!(e&&e.parse&&e.prototype&&e.prototype.getPayload))throw new TypeError("Invalid messageClass");this._messageClasses.unshift(e)},e.prototype.parse=function(e){debug$a("parsing message: %O",e);var t=!0,n=!1,r=void 0;try{for(var s,i=_getIterator(this._messageClasses);!(t=(s=i.next()).done);t=!0){var a=s.value,o=isPlainObject(e)?_Object$assign({},e):e,u=void 0,c=void 0;try{u=a.validate(o)}catch(e){}if(u){try{c=a.parse(o)}catch(e){console.warn("parsing a valid message content error",{error:e,Klass:a,content:o})}if(void 0!==c)return debug$a("parse result: %O",c),c}}}catch(e){n=!0,r=e}finally{try{!t&&i.return&&i.return()}finally{if(n)throw r}}throw new Error("No Message Class matched")},e}(),_applyDecoratedDescriptor$2(_class$6.prototype,"parse",[tryParseJson,applyPlugins],_Object$getOwnPropertyDescriptor(_class$6.prototype,"parse"),_class$6.prototype),_class$6),_this=void 0,debug$b=d("LC:IMPlugin"),MessagePriority={HIGH:1,NORMAL:2,LOW:3};_Object$freeze(MessagePriority);var defineConversationProperty=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{get:function(){return this.get(e)},set:function(t){this.set(e,t)}};_Object$defineProperty(Conversation.prototype,e,t)},onRealtimeCreate=function(e){var t=uuid();e._IMClients={},e._IMClientsCreationCount=0;var n=new MessageParser(e._plugins);e._messageParser=n;var r,s=(r=_asyncToGenerator(_regeneratorRuntime.mark((function t(n){return _regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e._request({method:"POST",path:"/rtm/sign",data:{session_token:n.getSessionToken()}}));case 1:case"end":return t.stop()}}),t,_this)}))),function(e){return r.apply(this,arguments)}),i=function(e){return ensureArray(e).map(n.register.bind(n))};i(ensureArray(e._plugins.messageClasses));var a,o=(a=_asyncToGenerator(_regeneratorRuntime.mark((function r(i){var a,o,u,c,p,d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},m=d.tag,l=d.isReconnect,h=_objectWithoutProperties(d,["tag","isReconnect"]),_=arguments[2];return _regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(o=void 0,u={},!i){r.next=18;break}if("string"!=typeof i){r.next=7;break}o=i,r.next=16;break;case 7:if(!i.id||!i.getSessionToken){r.next=15;break}if(o=i.id,i.getSessionToken()){r.next=12;break}throw new Error("User must be authenticated");case 12:u.signatureFactory=s,r.next=16;break;case 15:throw new TypeError("Identity must be a String or an AV.User");case 16:if(void 0===e._IMClients[o]){r.next=18;break}return r.abrupt("return",e._IMClients[o]);case 18:return _&&console.warn("DEPRECATION createIMClient tag param: Use options.tag instead."),c=m||_,p=(a=e._open().then((function(r){var s=new IMClient(o,_extends({},u,h),{_connection:r,_request:e._request.bind(e),_messageParser:n,_plugins:e._plugins,_identity:i});return r.on(RECONNECT,(function(){return s._open(e._options.appId,c,t,!0).then((function(){return s.emit(RECONNECT)}),(function(e){return s.emit(RECONNECT_ERROR,e)}))})),internal(s)._eventemitter.on("beforeclose",(function(){delete e._IMClients[s.id],e._firstIMClient===s&&delete e._firstIMClient}),e),internal(s)._eventemitter.on("close",(function(){e._deregister(s)}),e),s._open(e._options.appId,c,t,l).then((function(){return e._IMClients[s.id]=s,e._IMClientsCreationCount+=1,1===e._IMClientsCreationCount?(s._omitPeerId(!0),e._firstIMClient=s):e._IMClientsCreationCount>1&&e._firstIMClient&&e._firstIMClient._omitPeerId(!1),e._register(s),s})).catch((function(t){throw delete e._IMClients[s.id],t}))}))).then.apply(a,_toConsumableArray(finalize((function(){e._deregisterPending(p)})))),i&&(e._IMClients[o]=p),e._registerPending(p),r.abrupt("return",p);case 24:case"end":return r.stop()}}),r,_this)}))),function(e){return a.apply(this,arguments)});_Object$assign(e,{register:i,createIMClient:o})},beforeCommandDispatch=function(e,t){if(!(null===e.service||2===e.service))return!0;var n=e.peerId?t._IMClients[e.peerId]:t._firstIMClient;return n?_Promise.resolve(n).then((function(t){return t._dispatchCommand(e)})).catch(debug$b):debug$b("[WARN] Unexpected message received without any live client match: %O",trim(e)),!1},IMPlugin={name:"leancloud-realtime-plugin-im",onRealtimeCreate:onRealtimeCreate,beforeCommandDispatch:beforeCommandDispatch,messageClasses:[Message,BinaryMessage,RecalledMessage,TextMessage]};Realtime.defineConversationProperty=defineConversationProperty,Realtime.__preRegisteredPlugins=[IMPlugin];var Event$1=_extends({},CoreEvent,Event);exports.Promise=_Promise,exports.EventEmitter=EventEmitter,exports.Event=Event$1,exports.ErrorCode=ErrorCode,exports.Protocals=message,exports.Realtime=Realtime,exports.Message=Message,exports.BinaryMessage=BinaryMessage,exports.TypedMessage=TypedMessage,exports.TextMessage=TextMessage,exports.RecalledMessage=RecalledMessage,exports.MessagePriority=MessagePriority,exports.MessageStatus=MessageStatus,exports.MessageQueryDirection=MessageQueryDirection,exports.defineConversationProperty=defineConversationProperty,exports.IMPlugin=IMPlugin,exports.messageType=messageType,exports.messageField=messageField,exports.IE10Compatible=IE10Compatible,exports.ConversationMemberRole=ConversationMemberRole,exports.Conversation=Conversation,exports.ChatRoom=ChatRoom,exports.ServiceConversation=ServiceConversation,exports.TemporaryConversation=TemporaryConversation;
//# sourceMappingURL=/sm/e03bb51b06e544c6566b043367b8eb0c8a1ed7b79895d51f172f56bb6106222a.map